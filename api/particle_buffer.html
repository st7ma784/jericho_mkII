

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API Reference: ParticleBuffer &mdash; Jericho Mk II 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=51b770b3"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference: Field Arrays" href="fields.html" />
    <link rel="prev" title="MPI Parallelism" href="../mpi_parallelism.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Jericho Mk II
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html#prerequisites">Prerequisites</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#hardware-requirements">Hardware Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#software-requirements">Software Requirements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#step-1-install-cuda-toolkit">Step 1: Install CUDA Toolkit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#step-2-install-mpi-for-multi-gpu">Step 2: Install MPI (for Multi-GPU)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#step-3-clone-and-build-jericho-mk-ii">Step 3: Clone and Build Jericho Mk II</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html#running-your-first-simulation">Running Your First Simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#single-gpu-example">Single GPU Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#multi-gpu-example">Multi-GPU Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html#understanding-the-configuration-file">Understanding the Configuration File</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html#visualizing-results">Visualizing Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#basic-visualization-with-python">Basic Visualization with Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html#quick-reference-common-commands">Quick Reference: Common Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html#next-steps">Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#gpu-not-detected">GPU Not Detected</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#mpi-errors">MPI Errors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#out-of-memory">Out of Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting_started.html#performance-issues">Performance Issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html#getting-help">Getting Help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#configuration-file-structure">Configuration File Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#simulation-section">Simulation Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#domain-section">Domain Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#mpi-section">MPI Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#cuda-section">CUDA Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#particles-section">Particles Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#fields-section">Fields Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#boundaries-section">Boundaries Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#physics-section">Physics Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#output-section">Output Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#diagnostics-section">Diagnostics Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#complete-example">Complete Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#validation-and-testing">Validation and Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../running_simulations.html">Running Simulations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../running_simulations.html#basic-usage">Basic Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#single-gpu-simulation">Single GPU Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#command-line-options">Command Line Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../running_simulations.html#multi-gpu-simulations">Multi-GPU Simulations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#mpi-basics">MPI Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#gpu-assignment">GPU Assignment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#multi-node-simulations">Multi-Node Simulations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../running_simulations.html#output-files">Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#file-structure">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#field-output-files">Field Output Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#particle-output-files">Particle Output Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#diagnostics-csv">Diagnostics CSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#checkpoints">Checkpoints</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../running_simulations.html#visualization">Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#quick-plots-with-python">Quick Plots with Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#paraview-visualization">ParaView Visualization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../running_simulations.html#monitoring-and-diagnostics">Monitoring and Diagnostics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#real-time-monitoring">Real-Time Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#check-energy-conservation">Check Energy Conservation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#performance-monitoring">Performance Monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../running_simulations.html#common-simulation-scenarios">Common Simulation Scenarios</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#magnetic-reconnection">Magnetic Reconnection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#kelvin-helmholtz-instability">Kelvin-Helmholtz Instability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#solar-wind-interaction">Solar Wind Interaction</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../running_simulations.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#simulation-crashes">Simulation Crashes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_simulations.html#unexpected-results">Unexpected Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../running_simulations.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../running_simulations.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../output_formats.html">Output Formats</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../output_formats.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../output_formats.html#field-output-files">Field Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#file-naming-convention">File Naming Convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#hdf5-structure">HDF5 Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#field-datasets">Field Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#reading-field-files-in-python">Reading Field Files in Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../output_formats.html#particle-output-files">Particle Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#id1">File Naming Convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#id2">HDF5 Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#particle-datasets">Particle Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#reading-particle-files-in-python">Reading Particle Files in Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../output_formats.html#diagnostics-csv-file">Diagnostics CSV File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#file-structure">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#columns">Columns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#reading-diagnostics-in-python">Reading Diagnostics in Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../output_formats.html#checkpoint-files">Checkpoint Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#id3">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#restarting-from-checkpoint">Restarting from Checkpoint</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../output_formats.html#data-analysis-examples">Data Analysis Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#compute-derived-quantities">Compute Derived Quantities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#time-series-analysis">Time Series Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#spatial-analysis">Spatial Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../output_formats.html#exporting-to-other-formats">Exporting to Other Formats</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#convert-to-vtk-paraview">Convert to VTK (ParaView)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../output_formats.html#convert-to-netcdf">Convert to NetCDF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../output_formats.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture and Design</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#hybrid-pic-mhd-physics">Hybrid PIC-MHD Physics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#governing-equations">Governing Equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#why-hybrid">Why Hybrid?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#numerical-methods">Numerical Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#particle-in-cell-algorithm">Particle-in-Cell Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#boris-particle-pusher">Boris Particle Pusher</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#current-advance-method-cam">Current Advance Method (CAM)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#gpu-architecture">GPU Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#structure-of-arrays-soa">Structure of Arrays (SoA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#cuda-kernel-design">CUDA Kernel Design</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#mpi-cuda-hybrid-parallelism">MPI+CUDA Hybrid Parallelism</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#domain-decomposition">Domain Decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#ghost-cell-exchange">Ghost Cell Exchange</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#particle-migration">Particle Migration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#memory-management">Memory Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#gpu-memory-hierarchy">GPU Memory Hierarchy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#memory-allocation-strategy">Memory Allocation Strategy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#code-organization">Code Organization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#module-structure">Module Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#build-system">Build System</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#testing-strategy">Testing Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#integration-tests">Integration Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html#performance-benchmarks">Performance Benchmarks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#key-performance-metrics">Key Performance Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cuda_kernels.html">CUDA Kernels</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cuda_kernels.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_kernels.html#kernel-design-principles">Kernel Design Principles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_kernels.html#particle-kernels">Particle Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#particle-push-kernel">Particle Push Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#bilinear-interpolation">Bilinear Interpolation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#boris-rotation">Boris Rotation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#particle-to-grid-kernels">Particle-to-Grid Kernels</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_kernels.html#field-solver-kernels">Field Solver Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#ohm-s-law-kernel">Ohm’s Law Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#faraday-s-law-kernel">Faraday’s Law Kernel</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_kernels.html#boundary-condition-kernels">Boundary Condition Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#periodic-boundaries">Periodic Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#reflecting-boundaries">Reflecting Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#outflow-boundaries">Outflow Boundaries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_kernels.html#diagnostic-kernels">Diagnostic Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#kinetic-energy-kernel">Kinetic Energy Kernel</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_kernels.html#performance-optimization">Performance Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#memory-access-patterns">Memory Access Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#shared-memory-usage">Shared Memory Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#occupancy-tuning">Occupancy Tuning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#kernel-fusion">Kernel Fusion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_kernels.html#profiling-and-debugging">Profiling and Debugging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#using-nvprof">Using nvprof</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#using-nsight-compute">Using Nsight Compute</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cuda_kernels.html#cuda-memcheck">CUDA-MEMCHECK</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cuda_kernels.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mpi_parallelism.html">MPI Parallelism</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#why-mpi">Why MPI?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#domain-decomposition">Domain Decomposition</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#cartesian-grid-partitioning">Cartesian Grid Partitioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#neighbor-identification">Neighbor Identification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#ghost-cells">Ghost Cells</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#communication-patterns">Communication Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#ghost-cell-exchange">Ghost Cell Exchange</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#cuda-aware-mpi">CUDA-Aware MPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#particle-migration">Particle Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#collective-operations">Collective Operations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#load-balancing">Load Balancing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#static-load-balancing">Static Load Balancing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#dynamic-load-balancing-experimental">Dynamic Load Balancing (Experimental)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#performance-optimization">Performance Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#overlap-communication-and-computation">Overlap Communication and Computation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#cuda-aware-mpi-with-gpudirect-rdma">CUDA-Aware MPI with GPUDirect RDMA</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#minimize-ghost-cell-width">Minimize Ghost Cell Width</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#scaling-studies">Scaling Studies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#weak-scaling">Weak Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#strong-scaling">Strong Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#scaling-limits">Scaling Limits</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#debugging-mpi-programs">Debugging MPI Programs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#common-issues">Common Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#debugging-tools">Debugging Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mpi_parallelism.html#testing-mpi">Testing MPI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#configuration-example">Configuration Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mpi_parallelism.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">API Reference: ParticleBuffer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#class-jericho-particlebuffer">Class: <code class="docutils literal notranslate"><span class="pre">jericho::ParticleBuffer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#header-file">Header File</a></li>
<li class="toctree-l2"><a class="reference internal" href="#class-declaration">Class Declaration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#constructors">Constructors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#particlebuffer-size-t-initial-capacity-int-device-id-0">ParticleBuffer(size_t initial_capacity, int device_id = 0)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#particlebuffer">~ParticleBuffer()</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#member-functions">Member Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#memory-management">Memory Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#allocate-size-t-capacity">allocate(size_t capacity)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#destroy">destroy()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resize-size-t-new-capacity">resize(size_t new_capacity)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compact">compact()</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#particle-operations">Particle Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#add-particle-double-px-double-py-double-pvx-double-pvy-double-pweight-uint8-t-ptype">add_particle(double px, double py, double pvx, double pvy, double pweight, uint8_t ptype)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remove-particle-size-t-idx">remove_particle(size_t idx)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-particles-batch">add_particles_batch(…)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-transfer">Data Transfer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#copy-to-device">copy_to_device(…)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#copy-to-host">copy_to_host(…)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#accessors">Accessors</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#get-count">get_count()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-capacity">get_capacity()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-memory-bytes">get_memory_bytes()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#print-stats">print_stats()</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#helper-functions">Helper Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initialize-uniform">initialize_uniform(…)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#usage-examples">Usage Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-1-basic-usage">Example 1: Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-2-particle-migration">Example 2: Particle Migration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#performance-notes">Performance Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="fields.html">API Reference: Field Arrays</a><ul>
<li class="toctree-l2"><a class="reference internal" href="fields.html#quick-reference">Quick Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="fields.html#key-features">Key Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="fields.html#data-members">Data Members</a></li>
<li class="toctree-l2"><a class="reference internal" href="fields.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="boundaries.html">API Reference: Boundary Conditions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="boundaries.html#boundary-types">Boundary Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="boundaries.html#periodic-boundaries">Periodic Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="boundaries.html#outflow-boundaries">Outflow Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="boundaries.html#inflow-boundaries">Inflow Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="boundaries.html#reflecting-boundaries">Reflecting Boundaries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="boundaries.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="boundaries.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mpi_manager.html">API Reference: MPI Manager</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mpi_manager.html#quick-reference">Quick Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_manager.html#key-features">Key Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_manager.html#data-members">Data Members</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_manager.html#key-methods">Key Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_manager.html#domain-decomposition">Domain Decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_manager.html#communication">Communication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_manager.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_manager.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance_tuning.html">Performance Tuning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#performance-overview">Performance Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#target-performance-metrics">Target Performance Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#typical-performance">Typical Performance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#configuration-tuning">Configuration Tuning</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#timestep-selection">Timestep Selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#particles-per-cell">Particles Per Cell</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#grid-resolution">Grid Resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#output-cadence">Output Cadence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#cuda-optimization">CUDA Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#threads-per-block">Threads Per Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#memory-pool-size">Memory Pool Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#gpu-selection">GPU Selection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#mpi-optimization">MPI Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#domain-decomposition">Domain Decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#cuda-aware-mpi">CUDA-Aware MPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#overlap-communication">Overlap Communication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#profiling-and-analysis">Profiling and Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#using-nvidia-smi">Using nvidia-smi</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#using-nvprof">Using nvprof</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#using-nsight-systems">Using Nsight Systems</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#memory-usage-optimization">Memory Usage Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#estimate-memory-requirements">Estimate Memory Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#reduce-memory-usage">Reduce Memory Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#common-performance-issues">Common Performance Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#slow-particle-push">Slow Particle Push</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#slow-particle-to-grid">Slow Particle-to-Grid</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#poor-mpi-scaling">Poor MPI Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance_tuning.html#high-memory-usage">High Memory Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#best-practices-summary">Best Practices Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#performance-checklist">Performance Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance_tuning.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#build-issues">Build Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#nvcc-not-found">“nvcc not found”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#compute-capability-mismatch">“compute capability mismatch”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#mpi-not-found">“MPI not found”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#hdf5-not-found">“HDF5 not found”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#runtime-issues">Runtime Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#cuda-out-of-memory">“CUDA out of memory”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#no-cuda-capable-device">“No CUDA-capable device”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#mpi-init-failed">“MPI_Init failed”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#physics-issues">Physics Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#energy-not-conserved">Energy Not Conserved</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#no-magnetic-reconnection">No Magnetic Reconnection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#particles-escaping-domain">Particles Escaping Domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#nan-values-appearing">NaN Values Appearing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#performance-issues">Performance Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#simulation-too-slow">Simulation Too Slow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#poor-mpi-scaling">Poor MPI Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#gpu-thermal-throttling">GPU Thermal Throttling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#output-issues">Output Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#permission-denied-writing-output">“Permission denied” Writing Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#output-files-corrupted">Output Files Corrupted</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#diagnostic-collection">Diagnostic Collection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#before-reporting-issues">Before Reporting Issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#getting-help">Getting Help</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#self-help-resources">Self-Help Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#reporting-bugs">Reporting Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting.html#community-support">Community Support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#quick-checks">Quick Checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#common-mistakes">Common Mistakes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../citation.html">Citation and Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../citation.html#how-to-cite">How to Cite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#bibtex-entry">BibTeX Entry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#published-papers">Published Papers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#acknowledgments">Acknowledgments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../citation.html#contributing">Contributing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#types-of-contributions">Types of Contributions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#getting-started">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#code-style">Code Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#documentation">Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#testing">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#pull-request-guidelines">Pull Request Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#reporting-bugs">Reporting Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#requesting-features">Requesting Features</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../citation.html#code-of-conduct">Code of Conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="../citation.html#license">License</a></li>
<li class="toctree-l2"><a class="reference internal" href="../citation.html#credits">Credits</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#core-developers">Core Developers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#id1">Acknowledgments</a></li>
<li class="toctree-l3"><a class="reference internal" href="../citation.html#third-party-libraries">Third-Party Libraries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../citation.html#contact">Contact</a></li>
<li class="toctree-l2"><a class="reference internal" href="../citation.html#funding">Funding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../citation.html#publications-using-jericho-mk-ii">Publications Using Jericho Mk II</a></li>
<li class="toctree-l2"><a class="reference internal" href="../citation.html#see-also">See Also</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Jericho Mk II</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">API Reference: ParticleBuffer</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/api/particle_buffer.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="api-reference-particlebuffer">
<h1>API Reference: ParticleBuffer<a class="headerlink" href="#api-reference-particlebuffer" title="Link to this heading"></a></h1>
<section id="class-jericho-particlebuffer">
<h2>Class: <code class="docutils literal notranslate"><span class="pre">jericho::ParticleBuffer</span></code><a class="headerlink" href="#class-jericho-particlebuffer" title="Link to this heading"></a></h2>
<p>GPU-optimized Structure of Arrays (SoA) particle buffer for efficient particle storage and manipulation.</p>
</section>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ParticleBuffer</span></code> class implements a Structure of Arrays (SoA) memory layout for particle data, designed for optimal GPU performance through coalesced memory access patterns.</p>
<p><strong>Key features:</strong></p>
<ul class="simple">
<li><p>Coalesced memory access (10-50x GPU speedup vs AoS)</p></li>
<li><p>Dynamic particle management (add/remove particles)</p></li>
<li><p>CUDA device memory resident</p></li>
<li><p>Efficient particle migration for MPI</p></li>
<li><p>Support for multiple species via type field</p></li>
</ul>
</section>
<section id="header-file">
<h2>Header File<a class="headerlink" href="#header-file" title="Link to this heading"></a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;particle_buffer.h&quot;</span>
</pre></div>
</div>
</section>
<section id="class-declaration">
<h2>Class Declaration<a class="headerlink" href="#class-declaration" title="Link to this heading"></a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">jericho</span><span class="w"> </span><span class="p">{</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ParticleBuffer</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Data members (GPU device pointers)</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">          </span><span class="c1">// X positions [m]</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w">          </span><span class="c1">// Y positions [m]</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">vx</span><span class="p">;</span><span class="w">         </span><span class="c1">// X velocities [m/s]</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">vy</span><span class="p">;</span><span class="w">         </span><span class="c1">// Y velocities [m/s]</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">weight</span><span class="p">;</span><span class="w">     </span><span class="c1">// Statistical weights</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w">      </span><span class="c1">// Species type index</span>
<span class="w">    </span><span class="kt">bool</span><span class="o">*</span><span class="w"> </span><span class="n">active</span><span class="p">;</span><span class="w">       </span><span class="c1">// Active flag</span>

<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">capacity</span><span class="p">;</span><span class="w">    </span><span class="c1">// Allocated capacity</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">       </span><span class="c1">// Active particle count</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">device_id</span><span class="p">;</span><span class="w">      </span><span class="c1">// CUDA device ID</span>

<span class="w">    </span><span class="c1">// Free slot management</span>
<span class="w">    </span><span class="kt">size_t</span><span class="o">*</span><span class="w"> </span><span class="n">free_slots</span><span class="p">;</span><span class="w"> </span><span class="c1">// Stack of free indices</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">free_count</span><span class="p">;</span><span class="w">  </span><span class="c1">// Number of free slots</span>

<span class="w">    </span><span class="c1">// Constructors/Destructors</span>
<span class="w">    </span><span class="n">ParticleBuffer</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">initial_capacity</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="o">~</span><span class="n">ParticleBuffer</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Memory management</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">capacity</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">resize</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">new_capacity</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">compact</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Particle operations</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">add_particle</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">px</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">py</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">pvx</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">pvy</span><span class="p">,</span>
<span class="w">                       </span><span class="kt">double</span><span class="w"> </span><span class="n">pweight</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ptype</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">remove_particle</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">add_particles_batch</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">positions</span><span class="p">,</span>
<span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">velocities</span><span class="p">,</span>
<span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">weights</span><span class="p">,</span>
<span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">types</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n_particles</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Data transfer</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">copy_to_device</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_y</span><span class="p">,</span>
<span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_vx</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_vy</span><span class="p">,</span>
<span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_weight</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">h_type</span><span class="p">,</span>
<span class="w">                       </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">copy_to_host</span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_x</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_y</span><span class="p">,</span>
<span class="w">                     </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_vx</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_vy</span><span class="p">,</span>
<span class="w">                     </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">h_weight</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">h_type</span><span class="p">,</span>
<span class="w">                     </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Accessors</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">get_count</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">get_capacity</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">capacity</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">get_memory_bytes</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">print_stats</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace jericho</span>
</pre></div>
</div>
</section>
<section id="constructors">
<h2>Constructors<a class="headerlink" href="#constructors" title="Link to this heading"></a></h2>
<section id="particlebuffer-size-t-initial-capacity-int-device-id-0">
<h3>ParticleBuffer(size_t initial_capacity, int device_id = 0)<a class="headerlink" href="#particlebuffer-size-t-initial-capacity-int-device-id-0" title="Link to this heading"></a></h3>
<p>Construct a particle buffer on specified GPU.</p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">initial_capacity</span></code> (size_t): Initial number of particle slots to allocate</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">device_id</span></code> (int): CUDA device ID (default: 0, use -1 for auto-assignment)</p></li>
</ul>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create buffer for 1 million particles on GPU 0</span>
<span class="n">jericho</span><span class="o">::</span><span class="n">ParticleBuffer</span><span class="w"> </span><span class="nf">particles</span><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li><p>Allocates GPU memory immediately</p></li>
<li><p>Use RAII or explicitly call <code class="docutils literal notranslate"><span class="pre">destroy()</span></code> to free memory</p></li>
<li><p>Capacity can be increased later with <code class="docutils literal notranslate"><span class="pre">resize()</span></code></p></li>
</ul>
</section>
<section id="particlebuffer">
<h3>~ParticleBuffer()<a class="headerlink" href="#particlebuffer" title="Link to this heading"></a></h3>
<p>Destructor - automatically frees GPU memory.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Automatic cleanup</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">jericho</span><span class="o">::</span><span class="n">ParticleBuffer</span><span class="w"> </span><span class="nf">particles</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Use particles...</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// Destructor called here, GPU memory freed</span>
</pre></div>
</div>
</section>
</section>
<section id="member-functions">
<h2>Member Functions<a class="headerlink" href="#member-functions" title="Link to this heading"></a></h2>
<section id="memory-management">
<h3>Memory Management<a class="headerlink" href="#memory-management" title="Link to this heading"></a></h3>
<section id="allocate-size-t-capacity">
<h4>allocate(size_t capacity)<a class="headerlink" href="#allocate-size-t-capacity" title="Link to this heading"></a></h4>
<p>Allocate GPU memory for particle arrays.</p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">capacity</span></code> (size_t): Number of particle slots to allocate</p></li>
</ul>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ParticleBuffer</span><span class="w"> </span><span class="nf">particles</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// Empty buffer</span>
<span class="n">particles</span><span class="p">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span><span class="w">  </span><span class="c1">// Allocate for 1M particles</span>
</pre></div>
</div>
</section>
<section id="destroy">
<h4>destroy()<a class="headerlink" href="#destroy" title="Link to this heading"></a></h4>
<p>Free all GPU memory.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">particles</span><span class="p">.</span><span class="n">destroy</span><span class="p">();</span>
<span class="c1">// All GPU arrays freed, capacity=0, count=0</span>
</pre></div>
</div>
<p><strong>Note:</strong> Called automatically by destructor.</p>
</section>
<section id="resize-size-t-new-capacity">
<h4>resize(size_t new_capacity)<a class="headerlink" href="#resize-size-t-new-capacity" title="Link to this heading"></a></h4>
<p>Resize buffer (may trigger reallocation and copy).</p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">new_capacity</span></code> (size_t): New capacity (must be ≥ count)</p></li>
</ul>
<p><strong>Throws:</strong> <code class="docutils literal notranslate"><span class="pre">std::runtime_error</span></code> if <code class="docutils literal notranslate"><span class="pre">new_capacity</span> <span class="pre">&lt;</span> <span class="pre">count</span></code></p>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Initially 1M capacity</span>
<span class="n">ParticleBuffer</span><span class="w"> </span><span class="nf">particles</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>

<span class="c1">// Need more space</span>
<span class="n">particles</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">2000000</span><span class="p">);</span><span class="w">  </span><span class="c1">// Doubles capacity</span>

<span class="c1">// Allocates new memory, copies existing particles, frees old memory</span>
</pre></div>
</div>
<p><strong>Performance:</strong> Expensive operation (involves GPU-GPU copy). Avoid frequent resizes by over-allocating initially.</p>
</section>
<section id="compact">
<h4>compact()<a class="headerlink" href="#compact" title="Link to this heading"></a></h4>
<p>Remove inactive particles by compacting buffer.</p>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// After many particle removals</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Active: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Capacity: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">capacity</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Free slots: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">free_count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="c1">// Compact to reclaim memory</span>
<span class="n">particles</span><span class="p">.</span><span class="n">compact</span><span class="p">();</span>

<span class="c1">// Now capacity ≈ count, free_count = 0</span>
</pre></div>
</div>
<p><strong>When to use:</strong></p>
<ul class="simple">
<li><p>After significant particle removal (e.g., outflow boundaries)</p></li>
<li><p>When <code class="docutils literal notranslate"><span class="pre">free_count</span></code> is large (&gt; 10% of capacity)</p></li>
<li><p>Before checkpointing (to reduce file size)</p></li>
</ul>
<p><strong>Performance:</strong> <span class="math notranslate nohighlight">\(O(n)\)</span> GPU kernel, synchronizes device.</p>
</section>
</section>
<section id="particle-operations">
<h3>Particle Operations<a class="headerlink" href="#particle-operations" title="Link to this heading"></a></h3>
<section id="add-particle-double-px-double-py-double-pvx-double-pvy-double-pweight-uint8-t-ptype">
<h4>add_particle(double px, double py, double pvx, double pvy, double pweight, uint8_t ptype)<a class="headerlink" href="#add-particle-double-px-double-py-double-pvx-double-pvy-double-pweight-uint8-t-ptype" title="Link to this heading"></a></h4>
<p>Add a single particle (inflow boundary).</p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">px,</span> <span class="pre">py</span></code> (double): Position [m]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pvx,</span> <span class="pre">pvy</span></code> (double): Velocity [m/s]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pweight</span></code> (double): Statistical weight (macroparticle multiplicity)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ptype</span></code> (uint8_t): Species type index (0=electrons, 1+=ions)</p></li>
</ul>
<p><strong>Returns:</strong> <code class="docutils literal notranslate"><span class="pre">size_t</span></code> - Index where particle was inserted, or <code class="docutils literal notranslate"><span class="pre">-1</span></code> if buffer full</p>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Add H+ particle at origin with 1000 km/s velocity</span>
<span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">add_particle</span><span class="p">(</span>
<span class="w">    </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">           </span><span class="c1">// Position (x, y)</span>
<span class="w">    </span><span class="mf">1.0e6</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">         </span><span class="c1">// Velocity (vx, vy) [m/s]</span>
<span class="w">    </span><span class="mf">1.0</span><span class="p">,</span><span class="w">                </span><span class="c1">// Weight</span>
<span class="w">    </span><span class="mi">1</span><span class="w">                   </span><span class="c1">// Type (1 = H+)</span>
<span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">-1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Particle added at index &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li><p>If buffer is full, automatically resizes with 1.5x growth factor</p></li>
<li><p>Relatively slow (host-device synchronization), prefer batch operations</p></li>
</ul>
</section>
<section id="remove-particle-size-t-idx">
<h4>remove_particle(size_t idx)<a class="headerlink" href="#remove-particle-size-t-idx" title="Link to this heading"></a></h4>
<p>Remove particle at index (outflow boundary).</p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">idx</span></code> (size_t): Index of particle to remove</p></li>
</ul>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Remove particle at index 12345</span>
<span class="n">particles</span><span class="p">.</span><span class="n">remove_particle</span><span class="p">(</span><span class="mi">12345</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li><p>Marks particle as inactive (<code class="docutils literal notranslate"><span class="pre">active[idx]</span> <span class="pre">=</span> <span class="pre">false</span></code>)</p></li>
<li><p>Adds index to free_slots stack for reuse</p></li>
<li><p>Actual memory not freed until <code class="docutils literal notranslate"><span class="pre">compact()</span></code> is called</p></li>
<li><p>Fast operation (no memory movement)</p></li>
</ul>
</section>
<section id="add-particles-batch">
<h4>add_particles_batch(…)<a class="headerlink" href="#add-particles-batch" title="Link to this heading"></a></h4>
<p>Batch add particles (efficient for inflow boundaries).</p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">positions</span></code> (const double*): Host array <code class="docutils literal notranslate"><span class="pre">[x0,y0,x1,y1,...]</span></code> (size: 2*n)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">velocities</span></code> (const double*): Host array <code class="docutils literal notranslate"><span class="pre">[vx0,vy0,vx1,vy1,...]</span></code> (size: 2*n)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">weights</span></code> (const double*): Host array (size: n)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">types</span></code> (const uint8_t*): Host array (size: n)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_particles</span></code> (size_t): Number of particles to add</p></li>
</ul>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Prepare data on host</span>
<span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">positions</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">velocities</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">weights</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">types</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// All H+</span>

<span class="c1">// Initialize positions and velocities</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">positions</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* x */</span><span class="p">;</span>
<span class="w">    </span><span class="n">positions</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* y */</span><span class="p">;</span>
<span class="w">    </span><span class="n">velocities</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* vx */</span><span class="p">;</span>
<span class="w">    </span><span class="n">velocities</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* vy */</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Batch add</span>
<span class="n">particles</span><span class="p">.</span><span class="n">add_particles_batch</span><span class="p">(</span>
<span class="w">    </span><span class="n">positions</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">velocities</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span>
<span class="w">    </span><span class="n">weights</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">types</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Performance:</strong> Much faster than calling <code class="docutils literal notranslate"><span class="pre">add_particle()</span></code> in a loop (batched GPU transfer).</p>
</section>
</section>
<section id="data-transfer">
<h3>Data Transfer<a class="headerlink" href="#data-transfer" title="Link to this heading"></a></h3>
<section id="copy-to-device">
<h4>copy_to_device(…)<a class="headerlink" href="#copy-to-device" title="Link to this heading"></a></h4>
<p>Copy particle data from host to device.</p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">h_x,</span> <span class="pre">h_y,</span> <span class="pre">h_vx,</span> <span class="pre">h_vy,</span> <span class="pre">h_weight</span></code> (const double*): Host arrays</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">h_type</span></code> (const uint8_t*): Host array</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n</span></code> (size_t): Number of particles to copy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">offset</span></code> (size_t): Offset in device arrays (default: 0)</p></li>
</ul>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Initialize particles on host</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">h_x</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">h_y</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">h_vx</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">h_vy</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">h_weight</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">h_type</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

<span class="c1">// ... fill arrays ...</span>

<span class="c1">// Copy to GPU</span>
<span class="n">particles</span><span class="p">.</span><span class="n">copy_to_device</span><span class="p">(</span>
<span class="w">    </span><span class="n">h_x</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">h_y</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">h_vx</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">h_vy</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span>
<span class="w">    </span><span class="n">h_weight</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">h_type</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="copy-to-host">
<h4>copy_to_host(…)<a class="headerlink" href="#copy-to-host" title="Link to this heading"></a></h4>
<p>Copy particle data from device to host.</p>
<p><strong>Parameters:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">h_x,</span> <span class="pre">h_y,</span> <span class="pre">h_vx,</span> <span class="pre">h_vy,</span> <span class="pre">h_weight</span></code> (double*): Host arrays (pre-allocated)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">h_type</span></code> (uint8_t*): Host array (pre-allocated)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n</span></code> (size_t): Number of particles to copy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">offset</span></code> (size_t): Offset in device arrays (default: 0)</p></li>
</ul>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Allocate host memory</span>
<span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">get_count</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">h_x</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">h_y</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">h_vx</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">h_vy</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">h_weight</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">h_type</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

<span class="c1">// Copy from GPU</span>
<span class="n">particles</span><span class="p">.</span><span class="n">copy_to_host</span><span class="p">(</span>
<span class="w">    </span><span class="n">h_x</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">h_y</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">h_vx</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">h_vy</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span>
<span class="w">    </span><span class="n">h_weight</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">h_type</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="c1">// Now h_x, h_y, etc. contain particle data</span>
</pre></div>
</div>
</section>
</section>
<section id="accessors">
<h3>Accessors<a class="headerlink" href="#accessors" title="Link to this heading"></a></h3>
<section id="get-count">
<h4>get_count()<a class="headerlink" href="#get-count" title="Link to this heading"></a></h4>
<p>Get number of active particles.</p>
<p><strong>Returns:</strong> <code class="docutils literal notranslate"><span class="pre">size_t</span></code> - Active particle count</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">get_count</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Active particles: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="get-capacity">
<h4>get_capacity()<a class="headerlink" href="#get-capacity" title="Link to this heading"></a></h4>
<p>Get buffer capacity.</p>
<p><strong>Returns:</strong> <code class="docutils literal notranslate"><span class="pre">size_t</span></code> - Total allocated slots</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span><span class="w"> </span><span class="n">cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">get_capacity</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Buffer capacity: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cap</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Utilization: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mf">100.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">get_count</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cap</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="get-memory-bytes">
<h4>get_memory_bytes()<a class="headerlink" href="#get-memory-bytes" title="Link to this heading"></a></h4>
<p>Get memory usage in bytes.</p>
<p><strong>Returns:</strong> <code class="docutils literal notranslate"><span class="pre">size_t</span></code> - Total GPU memory used</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">get_memory_bytes</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;GPU memory: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e6</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; MB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Formula:</strong></p>
<div class="math notranslate nohighlight">
\[\text{bytes} = \text{capacity} \times (5 \times 8 + 1 + 1) = \text{capacity} \times 42\]</div>
</section>
<section id="print-stats">
<h4>print_stats()<a class="headerlink" href="#print-stats" title="Link to this heading"></a></h4>
<p>Print buffer statistics to stdout.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">particles</span><span class="p">.</span><span class="n">print_stats</span><span class="p">();</span>
</pre></div>
</div>
<p><strong>Output:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ParticleBuffer Statistics:
  Device: 0
  Capacity: 1000000
  Active count: 856234
  Free slots: 143766
  Memory: 42.0 MB
  Utilization: 85.6%
</pre></div>
</div>
</section>
</section>
</section>
<section id="helper-functions">
<h2>Helper Functions<a class="headerlink" href="#helper-functions" title="Link to this heading"></a></h2>
<section id="initialize-uniform">
<h3>initialize_uniform(…)<a class="headerlink" href="#initialize-uniform" title="Link to this heading"></a></h3>
<p>Initialize particles uniformly in rectangular domain.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_uniform</span><span class="p">(</span>
<span class="w">    </span><span class="n">ParticleBuffer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">x_min</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">x_max</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">y_min</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">y_max</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">particles_per_cell</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ny</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">weight</span><span class="p">,</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vx_mean</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">vy_mean</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">v_thermal</span><span class="p">,</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Example:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ParticleBuffer</span><span class="w"> </span><span class="nf">particles</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// Initialize H+ uniformly in domain</span>
<span class="n">initialize_uniform</span><span class="p">(</span>
<span class="w">    </span><span class="n">particles</span><span class="p">,</span>
<span class="w">    </span><span class="mf">-10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">,</span><span class="w">  </span><span class="c1">// Domain bounds</span>
<span class="w">    </span><span class="mi">100</span><span class="p">,</span><span class="w">                        </span><span class="c1">// 100 particles per cell</span>
<span class="w">    </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w">                   </span><span class="c1">// 256x256 grid</span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                          </span><span class="c1">// Type = H+</span>
<span class="w">    </span><span class="mf">1.0</span><span class="p">,</span><span class="w">                        </span><span class="c1">// Weight</span>
<span class="w">    </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">                   </span><span class="c1">// No drift</span>
<span class="w">    </span><span class="mf">1.0e5</span><span class="p">,</span><span class="w">                      </span><span class="c1">// 100 km/s thermal velocity</span>
<span class="w">    </span><span class="mi">42</span><span class="w">                          </span><span class="c1">// Random seed</span>
<span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Initialized &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">get_count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; particles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="usage-examples">
<h2>Usage Examples<a class="headerlink" href="#usage-examples" title="Link to this heading"></a></h2>
<section id="example-1-basic-usage">
<h3>Example 1: Basic Usage<a class="headerlink" href="#example-1-basic-usage" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;particle_buffer.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create buffer for 1M particles on GPU 0</span>
<span class="w">    </span><span class="n">jericho</span><span class="o">::</span><span class="n">ParticleBuffer</span><span class="w"> </span><span class="n">particles</span><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Add some particles</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">particles</span><span class="p">.</span><span class="n">add_particle</span><span class="p">(</span>
<span class="w">            </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">    </span><span class="c1">// Position</span>
<span class="w">            </span><span class="mf">1.0e6</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">      </span><span class="c1">// Velocity</span>
<span class="w">            </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">           </span><span class="c1">// Weight, type</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Added &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">get_count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; particles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="n">particles</span><span class="p">.</span><span class="n">print_stats</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="example-2-particle-migration">
<h3>Example 2: Particle Migration<a class="headerlink" href="#example-2-particle-migration" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">migrate_particles</span><span class="p">(</span><span class="n">ParticleBuffer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span>
<span class="w">                      </span><span class="kt">double</span><span class="w"> </span><span class="n">x_min</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">x_max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Identify particles to remove (left domain)</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">to_remove</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Copy positions to host</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">get_count</span><span class="p">();</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">h_x</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="w">    </span><span class="n">particles</span><span class="p">.</span><span class="n">copy_to_host</span><span class="p">(</span><span class="n">h_x</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span>
<span class="w">                          </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Check which particles left domain</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">x_min</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">h_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">x_max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_remove</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Remove them</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">to_remove</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">particles</span><span class="p">.</span><span class="n">remove_particle</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Removed &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">to_remove</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; particles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Compact if many removed</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particles</span><span class="p">.</span><span class="n">free_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">capacity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">particles</span><span class="p">.</span><span class="n">compact</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-notes">
<h2>Performance Notes<a class="headerlink" href="#performance-notes" title="Link to this heading"></a></h2>
<p><strong>Memory layout comparison:</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Layout</p></th>
<th class="head"><p>Memory pattern</p></th>
<th class="head"><p>GPU performance</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>AoS (bad)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[x0,y0,vx0,vy0][x1,y1,vx1,vy1]...</span></code></p></td>
<td><p>Scattered reads (slow)</p></td>
</tr>
<tr class="row-odd"><td><p>SoA (good)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[x0,x1,x2,...][y0,y1,y2,...]...</span></code></p></td>
<td><p>Coalesced reads (fast)</p></td>
</tr>
</tbody>
</table>
<p><strong>Performance gains:</strong></p>
<ul class="simple">
<li><p>10-50x speedup on GPU vs AoS</p></li>
<li><p>4-8x speedup on CPU (SIMD vectorization)</p></li>
<li><p>Better cache utilization</p></li>
</ul>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../architecture.html"><span class="doc">Architecture and Design</span></a> - Overall design</p></li>
<li><p><a class="reference internal" href="../cuda_kernels.html"><span class="doc">CUDA Kernels</span></a> - GPU kernels using ParticleBuffer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">include/particle_buffer.h</span></code> - Full header file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/particle_buffer.cpp</span></code> - Implementation</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../mpi_parallelism.html" class="btn btn-neutral float-left" title="MPI Parallelism" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fields.html" class="btn btn-neutral float-right" title="API Reference: Field Arrays" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lancaster University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>