

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Architecture and Design &mdash; Jericho Mk II 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=51b770b3"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="CUDA Kernels" href="cuda_kernels.html" />
    <link rel="prev" title="Output Formats" href="output_formats.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Jericho Mk II
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#prerequisites">Prerequisites</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#hardware-requirements">Hardware Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#software-requirements">Software Requirements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#step-1-install-cuda-toolkit">Step 1: Install CUDA Toolkit</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#step-2-install-mpi-for-multi-gpu">Step 2: Install MPI (for Multi-GPU)</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#step-3-clone-and-build-jericho-mk-ii">Step 3: Clone and Build Jericho Mk II</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#running-your-first-simulation">Running Your First Simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#single-gpu-example">Single GPU Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#multi-gpu-example">Multi-GPU Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#understanding-the-configuration-file">Understanding the Configuration File</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#visualizing-results">Visualizing Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#basic-visualization-with-python">Basic Visualization with Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#quick-reference-common-commands">Quick Reference: Common Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#next-steps">Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#gpu-not-detected">GPU Not Detected</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#mpi-errors">MPI Errors</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#out-of-memory">Out of Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#performance-issues">Performance Issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#getting-help">Getting Help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-file-structure">Configuration File Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#simulation-section">Simulation Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#domain-section">Domain Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#mpi-section">MPI Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#cuda-section">CUDA Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#particles-section">Particles Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#fields-section">Fields Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#boundaries-section">Boundaries Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#physics-section">Physics Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#output-section">Output Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#diagnostics-section">Diagnostics Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#complete-example">Complete Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#validation-and-testing">Validation and Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="running_simulations.html">Running Simulations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#basic-usage">Basic Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#single-gpu-simulation">Single GPU Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#command-line-options">Command Line Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#multi-gpu-simulations">Multi-GPU Simulations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#mpi-basics">MPI Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#gpu-assignment">GPU Assignment</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#multi-node-simulations">Multi-Node Simulations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#output-files">Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#file-structure">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#field-output-files">Field Output Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#particle-output-files">Particle Output Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#diagnostics-csv">Diagnostics CSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#checkpoints">Checkpoints</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#visualization">Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#quick-plots-with-python">Quick Plots with Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#paraview-visualization">ParaView Visualization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#monitoring-and-diagnostics">Monitoring and Diagnostics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#real-time-monitoring">Real-Time Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#check-energy-conservation">Check Energy Conservation</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#performance-monitoring">Performance Monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#common-simulation-scenarios">Common Simulation Scenarios</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#magnetic-reconnection">Magnetic Reconnection</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#kelvin-helmholtz-instability">Kelvin-Helmholtz Instability</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#solar-wind-interaction">Solar Wind Interaction</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#simulation-crashes">Simulation Crashes</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#unexpected-results">Unexpected Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="output_formats.html">Output Formats</a><ul>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#field-output-files">Field Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#file-naming-convention">File Naming Convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#hdf5-structure">HDF5 Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#field-datasets">Field Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#reading-field-files-in-python">Reading Field Files in Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#particle-output-files">Particle Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#id1">File Naming Convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#id2">HDF5 Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#particle-datasets">Particle Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#reading-particle-files-in-python">Reading Particle Files in Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#diagnostics-csv-file">Diagnostics CSV File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#file-structure">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#columns">Columns</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#reading-diagnostics-in-python">Reading Diagnostics in Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#checkpoint-files">Checkpoint Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#id3">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#restarting-from-checkpoint">Restarting from Checkpoint</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#data-analysis-examples">Data Analysis Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#compute-derived-quantities">Compute Derived Quantities</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#time-series-analysis">Time Series Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#spatial-analysis">Spatial Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#exporting-to-other-formats">Exporting to Other Formats</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#convert-to-vtk-paraview">Convert to VTK (ParaView)</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#convert-to-netcdf">Convert to NetCDF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Architecture and Design</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hybrid-pic-mhd-physics">Hybrid PIC-MHD Physics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#governing-equations">Governing Equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#why-hybrid">Why Hybrid?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#numerical-methods">Numerical Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#particle-in-cell-algorithm">Particle-in-Cell Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#boris-particle-pusher">Boris Particle Pusher</a></li>
<li class="toctree-l3"><a class="reference internal" href="#current-advance-method-cam">Current Advance Method (CAM)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gpu-architecture">GPU Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#structure-of-arrays-soa">Structure of Arrays (SoA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cuda-kernel-design">CUDA Kernel Design</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mpi-cuda-hybrid-parallelism">MPI+CUDA Hybrid Parallelism</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#domain-decomposition">Domain Decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ghost-cell-exchange">Ghost Cell Exchange</a></li>
<li class="toctree-l3"><a class="reference internal" href="#particle-migration">Particle Migration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#memory-management">Memory Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gpu-memory-hierarchy">GPU Memory Hierarchy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#memory-allocation-strategy">Memory Allocation Strategy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#code-organization">Code Organization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#module-structure">Module Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-system">Build System</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#testing-strategy">Testing Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#integration-tests">Integration Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performance-benchmarks">Performance Benchmarks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#key-performance-metrics">Key Performance Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cuda_kernels.html">CUDA Kernels</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#kernel-design-principles">Kernel Design Principles</a></li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#particle-kernels">Particle Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#particle-push-kernel">Particle Push Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#bilinear-interpolation">Bilinear Interpolation</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#boris-rotation">Boris Rotation</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#particle-to-grid-kernels">Particle-to-Grid Kernels</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#field-solver-kernels">Field Solver Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#ohm-s-law-kernel">Ohm’s Law Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#faraday-s-law-kernel">Faraday’s Law Kernel</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#boundary-condition-kernels">Boundary Condition Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#periodic-boundaries">Periodic Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#reflecting-boundaries">Reflecting Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#outflow-boundaries">Outflow Boundaries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#diagnostic-kernels">Diagnostic Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#kinetic-energy-kernel">Kinetic Energy Kernel</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#performance-optimization">Performance Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#memory-access-patterns">Memory Access Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#shared-memory-usage">Shared Memory Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#occupancy-tuning">Occupancy Tuning</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#kernel-fusion">Kernel Fusion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#profiling-and-debugging">Profiling and Debugging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#using-nvprof">Using nvprof</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#using-nsight-compute">Using Nsight Compute</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#cuda-memcheck">CUDA-MEMCHECK</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mpi_parallelism.html">MPI Parallelism</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#why-mpi">Why MPI?</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#domain-decomposition">Domain Decomposition</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#cartesian-grid-partitioning">Cartesian Grid Partitioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#neighbor-identification">Neighbor Identification</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#ghost-cells">Ghost Cells</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#communication-patterns">Communication Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#ghost-cell-exchange">Ghost Cell Exchange</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#cuda-aware-mpi">CUDA-Aware MPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#particle-migration">Particle Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#collective-operations">Collective Operations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#load-balancing">Load Balancing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#static-load-balancing">Static Load Balancing</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#dynamic-load-balancing-experimental">Dynamic Load Balancing (Experimental)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#performance-optimization">Performance Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#overlap-communication-and-computation">Overlap Communication and Computation</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#cuda-aware-mpi-with-gpudirect-rdma">CUDA-Aware MPI with GPUDirect RDMA</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#minimize-ghost-cell-width">Minimize Ghost Cell Width</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#scaling-studies">Scaling Studies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#weak-scaling">Weak Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#strong-scaling">Strong Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#scaling-limits">Scaling Limits</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#debugging-mpi-programs">Debugging MPI Programs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#common-issues">Common Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#debugging-tools">Debugging Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#testing-mpi">Testing MPI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#configuration-example">Configuration Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/particle_buffer.html">API Reference: ParticleBuffer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#class-jericho-particlebuffer">Class: <code class="docutils literal notranslate"><span class="pre">jericho::ParticleBuffer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#header-file">Header File</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#class-declaration">Class Declaration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#constructors">Constructors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#particlebuffer-size-t-initial-capacity-int-device-id-0">ParticleBuffer(size_t initial_capacity, int device_id = 0)</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#particlebuffer">~ParticleBuffer()</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#member-functions">Member Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#memory-management">Memory Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#allocate-size-t-capacity">allocate(size_t capacity)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#destroy">destroy()</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#resize-size-t-new-capacity">resize(size_t new_capacity)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#compact">compact()</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#particle-operations">Particle Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#add-particle-double-px-double-py-double-pvx-double-pvy-double-pweight-uint8-t-ptype">add_particle(double px, double py, double pvx, double pvy, double pweight, uint8_t ptype)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#remove-particle-size-t-idx">remove_particle(size_t idx)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#add-particles-batch">add_particles_batch(…)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#data-transfer">Data Transfer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#copy-to-device">copy_to_device(…)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#copy-to-host">copy_to_host(…)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#accessors">Accessors</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#get-count">get_count()</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#get-capacity">get_capacity()</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#get-memory-bytes">get_memory_bytes()</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#print-stats">print_stats()</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#helper-functions">Helper Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#initialize-uniform">initialize_uniform(…)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#usage-examples">Usage Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#example-1-basic-usage">Example 1: Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#example-2-particle-migration">Example 2: Particle Migration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#performance-notes">Performance Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api/fields.html">API Reference: Field Arrays</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/fields.html#quick-reference">Quick Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/fields.html#key-features">Key Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/fields.html#data-members">Data Members</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/fields.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api/boundaries.html">API Reference: Boundary Conditions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/boundaries.html#boundary-types">Boundary Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/boundaries.html#periodic-boundaries">Periodic Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/boundaries.html#outflow-boundaries">Outflow Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/boundaries.html#inflow-boundaries">Inflow Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/boundaries.html#reflecting-boundaries">Reflecting Boundaries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/boundaries.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/boundaries.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api/mpi_manager.html">API Reference: MPI Manager</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#quick-reference">Quick Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#key-features">Key Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#data-members">Data Members</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#key-methods">Key Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/mpi_manager.html#domain-decomposition">Domain Decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/mpi_manager.html#communication">Communication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="performance_tuning.html">Performance Tuning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#performance-overview">Performance Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#target-performance-metrics">Target Performance Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#typical-performance">Typical Performance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#configuration-tuning">Configuration Tuning</a><ul>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#timestep-selection">Timestep Selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#particles-per-cell">Particles Per Cell</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#grid-resolution">Grid Resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#output-cadence">Output Cadence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#cuda-optimization">CUDA Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#threads-per-block">Threads Per Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#memory-pool-size">Memory Pool Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#gpu-selection">GPU Selection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#mpi-optimization">MPI Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#domain-decomposition">Domain Decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#cuda-aware-mpi">CUDA-Aware MPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#overlap-communication">Overlap Communication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#profiling-and-analysis">Profiling and Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#using-nvidia-smi">Using nvidia-smi</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#using-nvprof">Using nvprof</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#using-nsight-systems">Using Nsight Systems</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#memory-usage-optimization">Memory Usage Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#estimate-memory-requirements">Estimate Memory Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#reduce-memory-usage">Reduce Memory Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#common-performance-issues">Common Performance Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#slow-particle-push">Slow Particle Push</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#slow-particle-to-grid">Slow Particle-to-Grid</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#poor-mpi-scaling">Poor MPI Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="performance_tuning.html#high-memory-usage">High Memory Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#best-practices-summary">Best Practices Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#performance-checklist">Performance Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance_tuning.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#build-issues">Build Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#nvcc-not-found">“nvcc not found”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#compute-capability-mismatch">“compute capability mismatch”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#mpi-not-found">“MPI not found”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#hdf5-not-found">“HDF5 not found”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#runtime-issues">Runtime Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#cuda-out-of-memory">“CUDA out of memory”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#no-cuda-capable-device">“No CUDA-capable device”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#mpi-init-failed">“MPI_Init failed”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#physics-issues">Physics Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#energy-not-conserved">Energy Not Conserved</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#no-magnetic-reconnection">No Magnetic Reconnection</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#particles-escaping-domain">Particles Escaping Domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#nan-values-appearing">NaN Values Appearing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#performance-issues">Performance Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#simulation-too-slow">Simulation Too Slow</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#poor-mpi-scaling">Poor MPI Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#gpu-thermal-throttling">GPU Thermal Throttling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#output-issues">Output Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#permission-denied-writing-output">“Permission denied” Writing Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#output-files-corrupted">Output Files Corrupted</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#diagnostic-collection">Diagnostic Collection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#before-reporting-issues">Before Reporting Issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#getting-help">Getting Help</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#self-help-resources">Self-Help Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#reporting-bugs">Reporting Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#community-support">Community Support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#quick-checks">Quick Checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#common-mistakes">Common Mistakes</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="citation.html">Citation and Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="citation.html#how-to-cite">How to Cite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="citation.html#bibtex-entry">BibTeX Entry</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#published-papers">Published Papers</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#acknowledgments">Acknowledgments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#contributing">Contributing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="citation.html#types-of-contributions">Types of Contributions</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#getting-started">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#code-style">Code Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#documentation">Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#testing">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#pull-request-guidelines">Pull Request Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#reporting-bugs">Reporting Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#requesting-features">Requesting Features</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#code-of-conduct">Code of Conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#license">License</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#credits">Credits</a><ul>
<li class="toctree-l3"><a class="reference internal" href="citation.html#core-developers">Core Developers</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#id1">Acknowledgments</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#third-party-libraries">Third-Party Libraries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#contact">Contact</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#funding">Funding</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#publications-using-jericho-mk-ii">Publications Using Jericho Mk II</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#see-also">See Also</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Jericho Mk II</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Architecture and Design</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/architecture.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="architecture-and-design">
<h1>Architecture and Design<a class="headerlink" href="#architecture-and-design" title="Link to this heading"></a></h1>
<p>This document explains the computational architecture and design principles of Jericho Mk II, covering both the physics models and computer science implementation.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>Jericho Mk II is a <strong>hybrid Particle-in-Cell / Magnetohydrodynamic (PIC-MHD)</strong> code that simulates plasma dynamics by:</p>
<ol class="arabic simple">
<li><p><strong>Kinetic ions</strong>: Treated as individual particles (PIC approach)</p></li>
<li><p><strong>Fluid electrons</strong>: Treated as a massless, charge-neutralizing fluid (MHD approach)</p></li>
<li><p><strong>Self-consistent fields</strong>: Electromagnetic fields updated from particle distributions</p></li>
</ol>
<p>This hybrid approach balances accuracy (kinetic ions capture wave-particle interactions) with efficiency (fluid electrons avoid expensive high-frequency waves).</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="_static/hybrid_pic_mhd_schematic.png"><img alt="_static/hybrid_pic_mhd_schematic.png" src="_static/hybrid_pic_mhd_schematic.png" style="width: 600px;" />
</a>
<figcaption>
<p><span class="caption-text">Hybrid PIC-MHD conceptual diagram</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="hybrid-pic-mhd-physics">
<h2>Hybrid PIC-MHD Physics<a class="headerlink" href="#hybrid-pic-mhd-physics" title="Link to this heading"></a></h2>
<section id="governing-equations">
<h3>Governing Equations<a class="headerlink" href="#governing-equations" title="Link to this heading"></a></h3>
<p><strong>1. Particle equations of motion (ions):</strong></p>
<div class="math notranslate nohighlight">
\[\begin{split}\frac{d\mathbf{x}_i}{dt} &amp;= \mathbf{v}_i \\
\frac{d\mathbf{v}_i}{dt} &amp;= \frac{q_i}{m_i}(\mathbf{E} + \mathbf{v}_i \times \mathbf{B})\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span>, <span class="math notranslate nohighlight">\(\mathbf{v}_i\)</span> are particle position and velocity, <span class="math notranslate nohighlight">\(q_i\)</span>, <span class="math notranslate nohighlight">\(m_i\)</span> are charge and mass.</p>
<p><strong>2. Generalized Ohm’s Law (electrons):</strong></p>
<div class="math notranslate nohighlight">
\[\mathbf{E} = -\mathbf{v}_e \times \mathbf{B} + \frac{1}{en_e}\mathbf{J} \times \mathbf{B} + \eta\mathbf{J} - \frac{1}{en_e}\nabla p_e\]</div>
<p>Terms:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(-\mathbf{v}_e \times \mathbf{B}\)</span>: Convective electric field</p></li>
<li><p><span class="math notranslate nohighlight">\(\frac{1}{en_e}\mathbf{J} \times \mathbf{B}\)</span>: <strong>Hall term</strong> (ion-electron decoupling)</p></li>
<li><p><span class="math notranslate nohighlight">\(\eta\mathbf{J}\)</span>: Resistivity (dissipation)</p></li>
<li><p><span class="math notranslate nohighlight">\(-\frac{1}{en_e}\nabla p_e\)</span>: Electron pressure gradient</p></li>
</ul>
<p><strong>3. Faraday’s Law:</strong></p>
<div class="math notranslate nohighlight">
\[\frac{\partial \mathbf{B}}{\partial t} = -\nabla \times \mathbf{E}\]</div>
<p><strong>4. Charge continuity:</strong></p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \mathbf{E} = \frac{\rho}{\epsilon_0}, \quad \rho = \sum_s q_s n_s\]</div>
<p><strong>5. Current density:</strong></p>
<div class="math notranslate nohighlight">
\[\mathbf{J} = \sum_s q_s n_s \mathbf{v}_s\]</div>
<p>where <span class="math notranslate nohighlight">\(s\)</span> indexes particle species.</p>
</section>
<section id="why-hybrid">
<h3>Why Hybrid?<a class="headerlink" href="#why-hybrid" title="Link to this heading"></a></h3>
<p><strong>Advantages:</strong></p>
<ol class="arabic simple">
<li><p><strong>Computational efficiency</strong>: Avoids electron time scales (<span class="math notranslate nohighlight">\(\omega_{pe}\)</span> &gt;&gt; <span class="math notranslate nohighlight">\(\omega_{pi}\)</span>)</p></li>
<li><p><strong>Physical insight</strong>: Captures ion kinetics (key for reconnection, wave-particle interaction)</p></li>
<li><p><strong>Manageable particle count</strong>: Only ions are particles; electrons are fluid</p></li>
</ol>
<p><strong>When to use hybrid:</strong></p>
<ul class="simple">
<li><p>Ion-scale phenomena (<span class="math notranslate nohighlight">\(\sim d_i = c/\omega_{pi}\)</span>)</p></li>
<li><p>Magnetic reconnection</p></li>
<li><p>Kelvin-Helmholtz instability</p></li>
<li><p>Ion cyclotron waves</p></li>
<li><p>Magnetospheric dynamics</p></li>
</ul>
<p><strong>When NOT to use hybrid:</strong></p>
<ul class="simple">
<li><p>Electron-scale physics (use full PIC)</p></li>
<li><p>Strongly collisional plasmas (use MHD)</p></li>
<li><p>Relativistic effects (use relativistic PIC)</p></li>
</ul>
</section>
</section>
<section id="numerical-methods">
<h2>Numerical Methods<a class="headerlink" href="#numerical-methods" title="Link to this heading"></a></h2>
<section id="particle-in-cell-algorithm">
<h3>Particle-in-Cell Algorithm<a class="headerlink" href="#particle-in-cell-algorithm" title="Link to this heading"></a></h3>
<p>The PIC cycle consists of:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>1. Particle-to-Grid (P2G): Interpolate particle quantities → grid
2. Field Solve: Update E, B from charge/current
3. Grid-to-Particle (G2P): Interpolate fields → particles
4. Particle Push: Advance particle positions/velocities
</pre></div>
</div>
<p><strong>Detailed steps:</strong></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
\rho(\mathbf{x}) &amp;= \sum_i q_i S(\mathbf{x} - \mathbf{x}_i) &amp; \text{(Charge deposition)} \\
\mathbf{J}(\mathbf{x}) &amp;= \sum_i q_i \mathbf{v}_i S(\mathbf{x} - \mathbf{x}_i) &amp; \text{(Current deposition)} \\
\mathbf{E}^{n+1} &amp;= f(\rho^n, \mathbf{J}^n, \mathbf{B}^n) &amp; \text{(Ohm's law)} \\
\mathbf{B}^{n+1} &amp;= \mathbf{B}^n - \Delta t \, \nabla \times \mathbf{E}^{n+1} &amp; \text{(Faraday's law)} \\
\mathbf{v}_i^{n+1} &amp;= \mathbf{v}_i^n + \frac{q_i}{m_i}(\mathbf{E} + \mathbf{v}_i \times \mathbf{B})\Delta t &amp; \text{(Boris push)} \\
\mathbf{x}_i^{n+1} &amp;= \mathbf{x}_i^n + \mathbf{v}_i^{n+1} \Delta t &amp; \text{(Position update)}
\end{align}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(S(\mathbf{x})\)</span> is the shape function (typically bilinear).</p>
</section>
<section id="boris-particle-pusher">
<h3>Boris Particle Pusher<a class="headerlink" href="#boris-particle-pusher" title="Link to this heading"></a></h3>
<p>The <strong>Boris algorithm</strong> is the gold standard for particle pushing in electromagnetic PIC codes. It’s a leapfrog method that is:</p>
<ul class="simple">
<li><p><strong>Second-order accurate</strong> in time</p></li>
<li><p><strong>Velocity-conserving</strong>: Preserves <span class="math notranslate nohighlight">\(|\mathbf{v}|\)</span> when <span class="math notranslate nohighlight">\(\mathbf{E} = 0\)</span></p></li>
<li><p><strong>Gyro-invariant</strong>: Handles strong magnetic fields without instability</p></li>
</ul>
<p><strong>Algorithm:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>1. Half-step electric acceleration: v⁻ = vⁿ + (q/m) E Δt/2
2. Magnetic rotation: v⁺ = rotate(v⁻, B, Δt)
3. Half-step electric acceleration: vⁿ⁺¹ = v⁺ + (q/m) E Δt/2
4. Position update: xⁿ⁺¹ = xⁿ + vⁿ⁺¹ Δt
</pre></div>
</div>
<p><strong>Rotation step</strong> (the “Boris trick”):</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{t} &amp;= \frac{q}{m}\mathbf{B}\frac{\Delta t}{2} \\
\mathbf{s} &amp;= \frac{2\mathbf{t}}{1 + |\mathbf{t}|^2} \\
\mathbf{v}' &amp;= \mathbf{v}^- + \mathbf{v}^- \times \mathbf{t} \\
\mathbf{v}^+ &amp;= \mathbf{v}^- + \mathbf{v}' \times \mathbf{s}\end{split}\]</div>
<p><strong>Energy conservation:</strong></p>
<p>For <span class="math notranslate nohighlight">\(\mathbf{E} = 0\)</span>, <span class="math notranslate nohighlight">\(|\mathbf{v}^{n+1}| = |\mathbf{v}^n|\)</span> exactly (no numerical heating).</p>
<p><strong>Implementation</strong> in <code class="docutils literal notranslate"><span class="pre">boris_pusher.cpp</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">boris_push</span><span class="p">(</span><span class="kt">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vx</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vy</span><span class="p">,</span>
<span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="n">Ex</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">Ey</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">Bz</span><span class="p">,</span>
<span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="n">q_over_m</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">half_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">qm_half_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q_over_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">half_dt</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Step 1: Half E acceleration</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vx_minus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qm_half_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Ex</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vy_minus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qm_half_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Ey</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Step 2: B rotation (Boris rotation)</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qm_half_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Bz</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t2</span><span class="p">);</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vx_prime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vx_minus</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vy_minus</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vy_prime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vy_minus</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vx_minus</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vx_plus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vx_minus</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vy_prime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vy_plus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vy_minus</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vx_prime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Step 3: Half E acceleration</span>
<span class="w">    </span><span class="n">vx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vx_plus</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qm_half_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Ex</span><span class="p">;</span>
<span class="w">    </span><span class="n">vy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vy_plus</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qm_half_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Ey</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="current-advance-method-cam">
<h3>Current Advance Method (CAM)<a class="headerlink" href="#current-advance-method-cam" title="Link to this heading"></a></h3>
<p>The <strong>Current Advance Method</strong> improves numerical stability by updating current density in a way that respects charge conservation at the discrete level.</p>
<p><strong>Standard approach (unstable):</strong></p>
<div class="math notranslate nohighlight">
\[\mathbf{J}^{n+1} = \sum_i q_i \mathbf{v}_i^{n+1} S(\mathbf{x} - \mathbf{x}_i^{n+1})\]</div>
<p>Problem: Can violate discrete charge conservation, leading to non-physical charge accumulation.</p>
<p><strong>CAM approach (stable):</strong></p>
<div class="math notranslate nohighlight">
\[\mathbf{J}^{n+1} = \mathbf{J}^n + \frac{\rho^{n+1} - \rho^n}{\Delta t} + \text{corrections}\]</div>
<p>This ensures:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial \rho}{\partial t} + \nabla \cdot \mathbf{J} = 0\]</div>
<p>at the discrete level.</p>
<p><strong>Benefits:</strong></p>
<ul class="simple">
<li><p>Eliminates spurious charge accumulation</p></li>
<li><p>Allows larger timesteps</p></li>
<li><p>Critical for long-time simulations</p></li>
</ul>
<p><strong>Implementation:</strong> See <code class="docutils literal notranslate"><span class="pre">ampere_solver.cpp</span></code> for details.</p>
</section>
</section>
<section id="gpu-architecture">
<h2>GPU Architecture<a class="headerlink" href="#gpu-architecture" title="Link to this heading"></a></h2>
<section id="structure-of-arrays-soa">
<h3>Structure of Arrays (SoA)<a class="headerlink" href="#structure-of-arrays-soa" title="Link to this heading"></a></h3>
<p><strong>Traditional Array of Structures (AoS):</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">Particle</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">vx</span><span class="p">,</span><span class="w"> </span><span class="n">vy</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Particle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span><span class="w">  </span><span class="c1">// Bad for GPU!</span>
</pre></div>
</div>
<p><strong>Memory layout:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[x0,y0,vx0,vy0,w0,t0][x1,y1,vx1,vy1,w1,t1][x2,y2,vx2,vy2,w2,t2]...
^                     ^                     ^
Thread 0              Thread 1              Thread 2
</pre></div>
</div>
<p>Problem: Adjacent threads access non-adjacent memory → <strong>scattered reads</strong> (slow).</p>
<p><strong>Structure of Arrays (SoA):</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">ParticleBuffer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">    </span><span class="c1">// All x positions contiguous</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w">    </span><span class="c1">// All y positions contiguous</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">vx</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">vy</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">weight</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><strong>Memory layout:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>x:  [x0,x1,x2,x3,x4,...]
     ^  ^  ^  ^  ^
     T0 T1 T2 T3 T4  ← Coalesced access!

y:  [y0,y1,y2,y3,y4,...]
vx: [vx0,vx1,vx2,...]
...
</pre></div>
</div>
<p><strong>Performance impact:</strong></p>
<ul class="simple">
<li><p><strong>10-50x speedup</strong> on GPU due to coalesced memory access</p></li>
<li><p><strong>4-8x speedup</strong> on CPU due to SIMD vectorization</p></li>
<li><p>Better cache utilization</p></li>
</ul>
<p><strong>Trade-off:</strong> More complex indexing, but massively faster execution.</p>
</section>
<section id="cuda-kernel-design">
<h3>CUDA Kernel Design<a class="headerlink" href="#cuda-kernel-design" title="Link to this heading"></a></h3>
<p><strong>Typical kernel structure:</strong></p>
<div class="highlight-cuda notranslate"><div class="highlight"><pre><span></span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">advance_particles_kernel</span><span class="p">(</span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">vx</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">vy</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">Ex</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">Ey</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">Bz</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n_particles</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// Get particle index for this thread</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">n_particles</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">  </span><span class="c1">// Guard against overrun</span>

<span class="w">    </span><span class="c1">// Load particle data (coalesced read)</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">py</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">pvx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vx</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">pvy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// Interpolate fields at particle position</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">Ex_particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bilinear_interp</span><span class="p">(</span><span class="n">Ex</span><span class="p">,</span><span class="w"> </span><span class="n">px</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">Ey_particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bilinear_interp</span><span class="p">(</span><span class="n">Ey</span><span class="p">,</span><span class="w"> </span><span class="n">px</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">Bz_particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bilinear_interp</span><span class="p">(</span><span class="n">Bz</span><span class="p">,</span><span class="w"> </span><span class="n">px</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>

<span class="w">    </span><span class="c1">// Boris push</span>
<span class="w">    </span><span class="n">boris_push</span><span class="p">(</span><span class="n">pvx</span><span class="p">,</span><span class="w"> </span><span class="n">pvy</span><span class="p">,</span><span class="w"> </span><span class="n">Ex_particle</span><span class="p">,</span><span class="w"> </span><span class="n">Ey_particle</span><span class="p">,</span><span class="w"> </span><span class="n">Bz_particle</span><span class="p">,</span><span class="w"> </span><span class="n">q_over_m</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Update position</span>
<span class="w">    </span><span class="n">px</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">pvx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="p">;</span>
<span class="w">    </span><span class="n">py</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">pvy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dt</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Store results (coalesced write)</span>
<span class="w">    </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">px</span><span class="p">;</span>
<span class="w">    </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="p">;</span>
<span class="w">    </span><span class="n">vx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pvx</span><span class="p">;</span>
<span class="w">    </span><span class="n">vy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pvy</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Launch configuration:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">num_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n_particles</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">threads_per_block</span><span class="p">;</span>
<span class="n">advance_particles_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">num_blocks</span><span class="p">,</span><span class="w"> </span><span class="n">threads_per_block</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">particles</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">vx</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">vy</span><span class="p">,</span>
<span class="w">    </span><span class="n">fields</span><span class="p">.</span><span class="n">Ex</span><span class="p">,</span><span class="w"> </span><span class="n">fields</span><span class="p">.</span><span class="n">Ey</span><span class="p">,</span><span class="w"> </span><span class="n">fields</span><span class="p">.</span><span class="n">Bz</span><span class="p">,</span>
<span class="w">    </span><span class="n">particles</span><span class="p">.</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
</pre></div>
</div>
<p><strong>Key optimizations:</strong></p>
<ol class="arabic simple">
<li><p><strong>Coalesced memory access</strong>: Adjacent threads access adjacent memory</p></li>
<li><p><strong>Minimize divergence</strong>: Avoid <code class="docutils literal notranslate"><span class="pre">if</span></code> statements where possible</p></li>
<li><p><strong>Register reuse</strong>: Keep data in registers (fast) rather than global memory (slow)</p></li>
<li><p><strong>Occupancy</strong>: Aim for 50-100% occupancy (active warps / max warps)</p></li>
</ol>
</section>
</section>
<section id="mpi-cuda-hybrid-parallelism">
<h2>MPI+CUDA Hybrid Parallelism<a class="headerlink" href="#mpi-cuda-hybrid-parallelism" title="Link to this heading"></a></h2>
<section id="domain-decomposition">
<h3>Domain Decomposition<a class="headerlink" href="#domain-decomposition" title="Link to this heading"></a></h3>
<p>The simulation domain is divided into subdomains, each handled by one MPI rank (typically one GPU).</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Global domain (256x256):

┌─────────┬─────────┐
│ Rank 0  │ Rank 1  │  Each: 128x256
│ GPU 0   │ GPU 1   │
├─────────┼─────────┤
│ Rank 2  │ Rank 3  │
│ GPU 2   │ GPU 3   │
└─────────┴─────────┘
</pre></div>
</div>
<p><strong>Ghost cells:</strong> Each subdomain includes extra layers (ghost cells) for boundary data from neighbors.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Rank 0 (with ghost cells):

┌─┬──────────┬─┐
│G│          │G│  G = Ghost cells (from neighbors)
├─┼──────────┼─┤  Interior = Local computation
│G│ Interior │G│
├─┼──────────┼─┤
│G│          │G│
└─┴──────────┴─┘
</pre></div>
</div>
</section>
<section id="ghost-cell-exchange">
<h3>Ghost Cell Exchange<a class="headerlink" href="#ghost-cell-exchange" title="Link to this heading"></a></h3>
<p>After each field update, boundary data is exchanged between neighbors:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">exchange_ghost_cells</span><span class="p">(</span><span class="n">FieldArrays</span><span class="o">&amp;</span><span class="w"> </span><span class="n">fields</span><span class="p">,</span><span class="w"> </span><span class="n">MPIManager</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mpi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Pack boundary data into send buffers</span>
<span class="w">    </span><span class="n">pack_send_buffers</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span><span class="w"> </span><span class="n">mpi</span><span class="p">.</span><span class="n">comm_buffers</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Non-blocking sends/receives</span>
<span class="w">    </span><span class="n">MPI_Isend</span><span class="p">(</span><span class="n">send_left</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">neighbor_left</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">req_send_left</span><span class="p">);</span>
<span class="w">    </span><span class="n">MPI_Irecv</span><span class="p">(</span><span class="n">recv_left</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">neighbor_left</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">req_recv_left</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ... repeat for right, top, bottom</span>

<span class="w">    </span><span class="c1">// Wait for completion</span>
<span class="w">    </span><span class="n">MPI_Waitall</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">requests</span><span class="p">,</span><span class="w"> </span><span class="n">statuses</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Unpack received data into ghost cells</span>
<span class="w">    </span><span class="n">unpack_recv_buffers</span><span class="p">(</span><span class="n">mpi</span><span class="p">.</span><span class="n">comm_buffers</span><span class="p">,</span><span class="w"> </span><span class="n">fields</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>CUDA-aware MPI</strong> (if available):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Send directly from GPU device memory!</span>
<span class="n">MPI_Isend</span><span class="p">(</span><span class="n">fields</span><span class="p">.</span><span class="n">Ex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w">  </span><span class="c1">// Device pointer</span>
<span class="w">          </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">neighbor_left</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
</pre></div>
</div>
<p>This eliminates CPU staging and is <strong>2-5x faster</strong> for large messages.</p>
</section>
<section id="particle-migration">
<h3>Particle Migration<a class="headerlink" href="#particle-migration" title="Link to this heading"></a></h3>
<p>Particles that leave a subdomain must be sent to the appropriate neighbor:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">migrate_particles</span><span class="p">(</span><span class="n">ParticleBuffer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">MPIManager</span><span class="o">&amp;</span><span class="w"> </span><span class="n">mpi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Identify particles that crossed boundaries</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">send_to_left</span><span class="p">,</span><span class="w"> </span><span class="n">send_to_right</span><span class="p">,</span><span class="w"> </span><span class="p">...;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">particles</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particles</span><span class="p">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mpi</span><span class="p">.</span><span class="n">x_min_local</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">send_to_left</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particles</span><span class="p">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">mpi</span><span class="p">.</span><span class="n">x_max_local</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">send_to_right</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// ... similar for y boundaries</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Pack and send</span>
<span class="w">    </span><span class="n">pack_particles</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">send_to_left</span><span class="p">,</span><span class="w"> </span><span class="n">send_buffer_left</span><span class="p">);</span>
<span class="w">    </span><span class="n">MPI_Isend</span><span class="p">(</span><span class="n">send_buffer_left</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">neighbor_left</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>

<span class="w">    </span><span class="c1">// Receive and unpack</span>
<span class="w">    </span><span class="n">MPI_Recv</span><span class="p">(</span><span class="n">recv_buffer_left</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">neighbor_left</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">    </span><span class="n">unpack_particles</span><span class="p">(</span><span class="n">recv_buffer_left</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Remove migrated particles</span>
<span class="w">    </span><span class="n">remove_particles</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">send_to_left</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="memory-management">
<h2>Memory Management<a class="headerlink" href="#memory-management" title="Link to this heading"></a></h2>
<section id="gpu-memory-hierarchy">
<h3>GPU Memory Hierarchy<a class="headerlink" href="#gpu-memory-hierarchy" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 15.0%" />
<col style="width: 20.0%" />
<col style="width: 45.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Memory Type</p></th>
<th class="head"><p>Size</p></th>
<th class="head"><p>Latency</p></th>
<th class="head"><p>Usage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Registers</strong></p></td>
<td><p>64 KB/SM</p></td>
<td><p>1 cycle</p></td>
<td><p>Thread-local variables</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Shared Memory</strong></p></td>
<td><p>48-96 KB/SM</p></td>
<td><p>~30 cycles</p></td>
<td><p>Block-local communication</p></td>
</tr>
<tr class="row-even"><td><p><strong>L1 Cache</strong></p></td>
<td><p>128 KB/SM</p></td>
<td><p>~30 cycles</p></td>
<td><p>Automatic caching</p></td>
</tr>
<tr class="row-odd"><td><p><strong>L2 Cache</strong></p></td>
<td><p>6-40 MB</p></td>
<td><p>~200 cycles</p></td>
<td><p>Shared across SMs</p></td>
</tr>
<tr class="row-even"><td><p><strong>Global Memory</strong></p></td>
<td><p>8-80 GB</p></td>
<td><p>~500 cycles</p></td>
<td><p>Main data arrays</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Host Memory</strong></p></td>
<td><p>64+ GB</p></td>
<td><p>~100,000 cycles</p></td>
<td><p>Fallback storage</p></td>
</tr>
</tbody>
</table>
<p><strong>Design implications:</strong></p>
<ol class="arabic simple">
<li><p><strong>Minimize global memory accesses</strong>: Use registers/shared memory</p></li>
<li><p><strong>Coalesce accesses</strong>: SoA layout ensures this</p></li>
<li><p><strong>Reuse data</strong>: Keep frequently accessed data in faster memory</p></li>
<li><p><strong>Prefetch</strong>: Use asynchronous transfers to hide latency</p></li>
</ol>
</section>
<section id="memory-allocation-strategy">
<h3>Memory Allocation Strategy<a class="headerlink" href="#memory-allocation-strategy" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ParticleBuffer</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ParticleBuffer</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">capacity</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">device_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="n">device_id</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Allocate device memory</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vx</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vy</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">weight</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
<span class="w">        </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">active</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">bool</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Initialize to zero</span>
<span class="w">        </span><span class="n">cudaMemset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="w">        </span><span class="c1">// ... repeat for other arrays</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">~</span><span class="n">ParticleBuffer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Free device memory</span>
<span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="w">        </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// ... etc</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p><strong>Dynamic resizing:</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">ParticleBuffer::resize</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">new_capacity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_capacity</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">capacity</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Allocate new arrays</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">new_x</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">new_y</span><span class="p">,</span><span class="w"> </span><span class="p">...;</span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_x</span><span class="p">,</span><span class="w"> </span><span class="n">new_capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_y</span><span class="p">,</span><span class="w"> </span><span class="n">new_capacity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="c1">// Copy old data</span>
<span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToDevice</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">new_y</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToDevice</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="c1">// Free old arrays</span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="n">cudaFree</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="c1">// Update pointers</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_x</span><span class="p">;</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_y</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_capacity</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="code-organization">
<h2>Code Organization<a class="headerlink" href="#code-organization" title="Link to this heading"></a></h2>
<section id="module-structure">
<h3>Module Structure<a class="headerlink" href="#module-structure" title="Link to this heading"></a></h3>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>jericho_mkII/
├── src/                 # CPU host code
│   ├── main.cpp         # Entry point, simulation loop
│   ├── config.cpp       # TOML parser
│   ├── particle_buffer.cpp  # CPU memory management
│   ├── field_arrays.cpp     # CPU field management
│   ├── mpi_manager.cpp      # MPI domain decomposition
│   └── io_manager.cpp       # HDF5 output
│
├── cuda/                # GPU device code
│   ├── particles.cu     # Particle push kernels
│   ├── fields.cu        # Field update kernels
│   ├── boundaries.cu    # Boundary condition kernels
│   └── p2g.cu           # Particle-to-grid kernels
│
├── include/             # Header files
│   ├── particle_buffer.h
│   ├── field_arrays.h
│   ├── mpi_manager.h
│   ├── boris_pusher.h
│   └── platform.h       # CPU/GPU abstraction
│
└── tests/               # Unit tests
    ├── test_boris.cpp
    ├── test_p2g.cpp
    └── test_mpi.cpp
</pre></div>
</div>
<p><strong>Separation of concerns:</strong></p>
<ul class="simple">
<li><p><strong>src/</strong>: High-level logic, orchestration, I/O</p></li>
<li><p><strong>cuda/</strong>: Low-level compute kernels</p></li>
<li><p><strong>include/</strong>: Interface definitions, constants</p></li>
</ul>
<p><strong>Key design pattern: Platform abstraction</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">platform.h</span></code> provides CPU/GPU compatibility:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Compile for both CPU and GPU</span>
<span class="cp">#ifdef __CUDACC__</span>
<span class="cp">#define DEVICE_HOST __host__ __device__</span>
<span class="cp">#define GLOBAL __global__</span>
<span class="cp">#else</span>
<span class="cp">#define DEVICE_HOST</span>
<span class="cp">#define GLOBAL</span>
<span class="cp">#endif</span>

<span class="c1">// Same function works on CPU or GPU</span>
<span class="n">DEVICE_HOST</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">dot_product</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">ay</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">by</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ax</span><span class="o">*</span><span class="n">bx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ay</span><span class="o">*</span><span class="n">by</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="build-system">
<h3>Build System<a class="headerlink" href="#build-system" title="Link to this heading"></a></h3>
<p>CMake handles cross-platform builds:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># CMakeLists.txt</span>
<span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.18</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">jericho_mkII</span><span class="w"> </span><span class="s">LANGUAGES</span><span class="w"> </span><span class="s">CXX</span><span class="w"> </span><span class="s">CUDA</span><span class="p">)</span>

<span class="c"># C++17 standard</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span><span class="w"> </span><span class="s">17</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_STANDARD</span><span class="w"> </span><span class="s">17</span><span class="p">)</span>

<span class="c"># CUDA architecture (user-specified)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CUDA_ARCHITECTURES</span><span class="w"> </span><span class="s2">&quot;70;75;80;86&quot;</span><span class="w"> </span><span class="s">CACHE</span><span class="w"> </span><span class="s">STRING</span><span class="w"> </span><span class="s2">&quot;CUDA architectures&quot;</span><span class="p">)</span>

<span class="c"># Find MPI</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">HDF5</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>

<span class="c"># Executable</span>
<span class="nb">add_executable</span><span class="p">(</span><span class="s">jericho_mkII</span>
<span class="w">    </span><span class="s">src/main.cpp</span>
<span class="w">    </span><span class="s">src/config.cpp</span>
<span class="w">    </span><span class="s">src/particle_buffer.cpp</span>
<span class="w">    </span><span class="s">src/field_arrays.cpp</span>
<span class="w">    </span><span class="s">src/mpi_manager.cpp</span>
<span class="w">    </span><span class="s">cuda/particles.cu</span>
<span class="w">    </span><span class="s">cuda/fields.cu</span>
<span class="w">    </span><span class="s">cuda/boundaries.cu</span>
<span class="p">)</span>

<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">jericho_mkII</span>
<span class="w">    </span><span class="s">MPI::MPI_CXX</span>
<span class="w">    </span><span class="s">HDF5::HDF5</span>
<span class="w">    </span><span class="s">cudart</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="testing-strategy">
<h2>Testing Strategy<a class="headerlink" href="#testing-strategy" title="Link to this heading"></a></h2>
<section id="unit-tests">
<h3>Unit Tests<a class="headerlink" href="#unit-tests" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// tests/test_boris.cpp</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gtest/gtest.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;boris_pusher.h&quot;</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">BorisTest</span><span class="p">,</span><span class="w"> </span><span class="n">EnergyConservation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Test that Boris pusher conserves energy for E=0</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e6</span><span class="p">,</span><span class="w"> </span><span class="n">vy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">Ex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">Ey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">Bz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e-9</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">q_over_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">9.578e7</span><span class="p">;</span><span class="w">  </span><span class="c1">// Proton</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vx</span><span class="o">*</span><span class="n">vx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vy</span><span class="o">*</span><span class="n">vy</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Push 1000 timesteps</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">boris_push</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span><span class="w"> </span><span class="n">vy</span><span class="p">,</span><span class="w"> </span><span class="n">Ex</span><span class="p">,</span><span class="w"> </span><span class="n">Ey</span><span class="p">,</span><span class="w"> </span><span class="n">Bz</span><span class="p">,</span><span class="w"> </span><span class="n">q_over_m</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vx</span><span class="o">*</span><span class="n">vx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vy</span><span class="o">*</span><span class="n">vy</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Check energy conservation</span>
<span class="w">    </span><span class="n">EXPECT_NEAR</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-10</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="integration-tests">
<h3>Integration Tests<a class="headerlink" href="#integration-tests" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run full simulation and check output</span>
./jericho_mkII<span class="w"> </span>../examples/minimal_test.toml

<span class="c1"># Verify output files exist</span>
<span class="nb">test</span><span class="w"> </span>-f<span class="w"> </span>output/fields_000100.h5<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>

<span class="c1"># Check energy conservation</span>
python3<span class="w"> </span>scripts/check_energy_conservation.py<span class="w"> </span>output/diagnostics.csv
</pre></div>
</div>
</section>
<section id="performance-benchmarks">
<h3>Performance Benchmarks<a class="headerlink" href="#performance-benchmarks" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Measure kernel performance</span>
<span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">;</span>
<span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
<span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>

<span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
<span class="n">advance_particles_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">blocks</span><span class="p">,</span><span class="w"> </span><span class="n">threads</span><span class="o">&gt;&gt;&gt;</span><span class="p">(...);</span>
<span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>

<span class="n">cudaEventSynchronize</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
<span class="kt">float</span><span class="w"> </span><span class="n">milliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">cudaEventElapsedTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">milliseconds</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Particle push: %.3f ms (%.2f Gparticles/s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="n">milliseconds</span><span class="p">,</span><span class="w"> </span><span class="n">n_particles</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">milliseconds</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e6</span><span class="p">));</span>
</pre></div>
</div>
</section>
</section>
<section id="key-performance-metrics">
<h2>Key Performance Metrics<a class="headerlink" href="#key-performance-metrics" title="Link to this heading"></a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Metric</p></th>
<th class="head"><p>Target</p></th>
<th class="head"><p>Measurement</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Particles/sec</p></td>
<td><p>&gt; 1 Gparticles/s</p></td>
<td><p>Kernel timing</p></td>
</tr>
<tr class="row-odd"><td><p>GPU occupancy</p></td>
<td><p>50-100%</p></td>
<td><p>nvprof</p></td>
</tr>
<tr class="row-even"><td><p>Memory bandwidth</p></td>
<td><p>&gt; 70% peak</p></td>
<td><p>nvprof</p></td>
</tr>
<tr class="row-odd"><td><p>Energy conservation</p></td>
<td><p><span class="math notranslate nohighlight">\(|\Delta E|/E &lt; 1\%\)</span></p></td>
<td><p>Diagnostics</p></td>
</tr>
<tr class="row-even"><td><p>MPI efficiency</p></td>
<td><p>&gt; 80%</p></td>
<td><p>Weak scaling</p></td>
</tr>
<tr class="row-odd"><td><p>CUDA-aware MPI speedup</p></td>
<td><p>2-5x vs host-staged</p></td>
<td><p>Bandwidth test</p></td>
</tr>
</tbody>
</table>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="cuda_kernels.html"><span class="doc">CUDA Kernels</span></a> - Detailed CUDA implementation</p></li>
<li><p><a class="reference internal" href="mpi_parallelism.html"><span class="doc">MPI Parallelism</span></a> - Multi-GPU parallelization</p></li>
<li><p><a class="reference internal" href="performance_tuning.html"><span class="doc">Performance Tuning</span></a> - Optimization techniques</p></li>
<li><p><a class="reference internal" href="api/particle_buffer.html"><span class="doc">API Reference: ParticleBuffer</span></a> - API reference</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="output_formats.html" class="btn btn-neutral float-left" title="Output Formats" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cuda_kernels.html" class="btn btn-neutral float-right" title="CUDA Kernels" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lancaster University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>