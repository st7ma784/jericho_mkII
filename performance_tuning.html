

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Performance Tuning &mdash; Jericho Mk II 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=51b770b3"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Troubleshooting" href="troubleshooting.html" />
    <link rel="prev" title="API Reference: MPI Manager" href="api/mpi_manager.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Jericho Mk II
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#prerequisites">Prerequisites</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#hardware-requirements">Hardware Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#software-requirements">Software Requirements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#step-1-install-cuda-toolkit">Step 1: Install CUDA Toolkit</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#step-2-install-mpi-for-multi-gpu">Step 2: Install MPI (for Multi-GPU)</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#step-3-clone-and-build-jericho-mk-ii">Step 3: Clone and Build Jericho Mk II</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#running-your-first-simulation">Running Your First Simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#single-gpu-example">Single GPU Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#multi-gpu-example">Multi-GPU Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#understanding-the-configuration-file">Understanding the Configuration File</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#visualizing-results">Visualizing Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#basic-visualization-with-python">Basic Visualization with Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#quick-reference-common-commands">Quick Reference: Common Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#next-steps">Next Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#gpu-not-detected">GPU Not Detected</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#mpi-errors">MPI Errors</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#out-of-memory">Out of Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting_started.html#performance-issues">Performance Issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#getting-help">Getting Help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-file-structure">Configuration File Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#simulation-section">Simulation Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#domain-section">Domain Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#mpi-section">MPI Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#cuda-section">CUDA Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#particles-section">Particles Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#fields-section">Fields Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#boundaries-section">Boundaries Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#physics-section">Physics Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#output-section">Output Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#diagnostics-section">Diagnostics Section</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#complete-example">Complete Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#validation-and-testing">Validation and Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="running_simulations.html">Running Simulations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#basic-usage">Basic Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#single-gpu-simulation">Single GPU Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#command-line-options">Command Line Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#multi-gpu-simulations">Multi-GPU Simulations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#mpi-basics">MPI Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#gpu-assignment">GPU Assignment</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#multi-node-simulations">Multi-Node Simulations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#output-files">Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#file-structure">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#field-output-files">Field Output Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#particle-output-files">Particle Output Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#diagnostics-csv">Diagnostics CSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#checkpoints">Checkpoints</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#visualization">Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#quick-plots-with-python">Quick Plots with Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#paraview-visualization">ParaView Visualization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#monitoring-and-diagnostics">Monitoring and Diagnostics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#real-time-monitoring">Real-Time Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#check-energy-conservation">Check Energy Conservation</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#performance-monitoring">Performance Monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#common-simulation-scenarios">Common Simulation Scenarios</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#magnetic-reconnection">Magnetic Reconnection</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#kelvin-helmholtz-instability">Kelvin-Helmholtz Instability</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#solar-wind-interaction">Solar Wind Interaction</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#simulation-crashes">Simulation Crashes</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_simulations.html#unexpected-results">Unexpected Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="running_simulations.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="output_formats.html">Output Formats</a><ul>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#field-output-files">Field Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#file-naming-convention">File Naming Convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#hdf5-structure">HDF5 Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#field-datasets">Field Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#reading-field-files-in-python">Reading Field Files in Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#particle-output-files">Particle Output Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#id1">File Naming Convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#id2">HDF5 Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#particle-datasets">Particle Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#reading-particle-files-in-python">Reading Particle Files in Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#diagnostics-csv-file">Diagnostics CSV File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#file-structure">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#columns">Columns</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#reading-diagnostics-in-python">Reading Diagnostics in Python</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#checkpoint-files">Checkpoint Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#id3">File Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#restarting-from-checkpoint">Restarting from Checkpoint</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#data-analysis-examples">Data Analysis Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#compute-derived-quantities">Compute Derived Quantities</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#time-series-analysis">Time Series Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#spatial-analysis">Spatial Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#exporting-to-other-formats">Exporting to Other Formats</a><ul>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#convert-to-vtk-paraview">Convert to VTK (ParaView)</a></li>
<li class="toctree-l3"><a class="reference internal" href="output_formats.html#convert-to-netcdf">Convert to NetCDF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="output_formats.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture and Design</a><ul>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#hybrid-pic-mhd-physics">Hybrid PIC-MHD Physics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#governing-equations">Governing Equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#why-hybrid">Why Hybrid?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#numerical-methods">Numerical Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#particle-in-cell-algorithm">Particle-in-Cell Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#boris-particle-pusher">Boris Particle Pusher</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#current-advance-method-cam">Current Advance Method (CAM)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#gpu-architecture">GPU Architecture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#structure-of-arrays-soa">Structure of Arrays (SoA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#cuda-kernel-design">CUDA Kernel Design</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#mpi-cuda-hybrid-parallelism">MPI+CUDA Hybrid Parallelism</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#domain-decomposition">Domain Decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#ghost-cell-exchange">Ghost Cell Exchange</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#particle-migration">Particle Migration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#memory-management">Memory Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#gpu-memory-hierarchy">GPU Memory Hierarchy</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#memory-allocation-strategy">Memory Allocation Strategy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#code-organization">Code Organization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#module-structure">Module Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#build-system">Build System</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#testing-strategy">Testing Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#integration-tests">Integration Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#performance-benchmarks">Performance Benchmarks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#key-performance-metrics">Key Performance Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cuda_kernels.html">CUDA Kernels</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#kernel-design-principles">Kernel Design Principles</a></li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#particle-kernels">Particle Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#particle-push-kernel">Particle Push Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#bilinear-interpolation">Bilinear Interpolation</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#boris-rotation">Boris Rotation</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#particle-to-grid-kernels">Particle-to-Grid Kernels</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#field-solver-kernels">Field Solver Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#ohm-s-law-kernel">Ohm’s Law Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#faraday-s-law-kernel">Faraday’s Law Kernel</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#boundary-condition-kernels">Boundary Condition Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#periodic-boundaries">Periodic Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#reflecting-boundaries">Reflecting Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#outflow-boundaries">Outflow Boundaries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#diagnostic-kernels">Diagnostic Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#kinetic-energy-kernel">Kinetic Energy Kernel</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#performance-optimization">Performance Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#memory-access-patterns">Memory Access Patterns</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#shared-memory-usage">Shared Memory Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#occupancy-tuning">Occupancy Tuning</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#kernel-fusion">Kernel Fusion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#profiling-and-debugging">Profiling and Debugging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#using-nvprof">Using nvprof</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#using-nsight-compute">Using Nsight Compute</a></li>
<li class="toctree-l3"><a class="reference internal" href="cuda_kernels.html#cuda-memcheck">CUDA-MEMCHECK</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cuda_kernels.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mpi_parallelism.html">MPI Parallelism</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#why-mpi">Why MPI?</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#domain-decomposition">Domain Decomposition</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#cartesian-grid-partitioning">Cartesian Grid Partitioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#neighbor-identification">Neighbor Identification</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#ghost-cells">Ghost Cells</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#communication-patterns">Communication Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#ghost-cell-exchange">Ghost Cell Exchange</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#cuda-aware-mpi">CUDA-Aware MPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#particle-migration">Particle Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#collective-operations">Collective Operations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#load-balancing">Load Balancing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#static-load-balancing">Static Load Balancing</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#dynamic-load-balancing-experimental">Dynamic Load Balancing (Experimental)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#performance-optimization">Performance Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#overlap-communication-and-computation">Overlap Communication and Computation</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#cuda-aware-mpi-with-gpudirect-rdma">CUDA-Aware MPI with GPUDirect RDMA</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#minimize-ghost-cell-width">Minimize Ghost Cell Width</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#scaling-studies">Scaling Studies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#weak-scaling">Weak Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#strong-scaling">Strong Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#scaling-limits">Scaling Limits</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#debugging-mpi-programs">Debugging MPI Programs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#common-issues">Common Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#debugging-tools">Debugging Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpi_parallelism.html#testing-mpi">Testing MPI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#configuration-example">Configuration Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpi_parallelism.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/particle_buffer.html">API Reference: ParticleBuffer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#class-jericho-particlebuffer">Class: <code class="docutils literal notranslate"><span class="pre">jericho::ParticleBuffer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#header-file">Header File</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#class-declaration">Class Declaration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#constructors">Constructors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#particlebuffer-size-t-initial-capacity-int-device-id-0">ParticleBuffer(size_t initial_capacity, int device_id = 0)</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#particlebuffer">~ParticleBuffer()</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#member-functions">Member Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#memory-management">Memory Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#allocate-size-t-capacity">allocate(size_t capacity)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#destroy">destroy()</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#resize-size-t-new-capacity">resize(size_t new_capacity)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#compact">compact()</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#particle-operations">Particle Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#add-particle-double-px-double-py-double-pvx-double-pvy-double-pweight-uint8-t-ptype">add_particle(double px, double py, double pvx, double pvy, double pweight, uint8_t ptype)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#remove-particle-size-t-idx">remove_particle(size_t idx)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#add-particles-batch">add_particles_batch(…)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#data-transfer">Data Transfer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#copy-to-device">copy_to_device(…)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#copy-to-host">copy_to_host(…)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#accessors">Accessors</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#get-count">get_count()</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#get-capacity">get_capacity()</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#get-memory-bytes">get_memory_bytes()</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/particle_buffer.html#print-stats">print_stats()</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#helper-functions">Helper Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#initialize-uniform">initialize_uniform(…)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#usage-examples">Usage Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#example-1-basic-usage">Example 1: Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/particle_buffer.html#example-2-particle-migration">Example 2: Particle Migration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#performance-notes">Performance Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/particle_buffer.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api/fields.html">API Reference: Field Arrays</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/fields.html#quick-reference">Quick Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/fields.html#key-features">Key Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/fields.html#data-members">Data Members</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/fields.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api/boundaries.html">API Reference: Boundary Conditions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/boundaries.html#boundary-types">Boundary Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/boundaries.html#periodic-boundaries">Periodic Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/boundaries.html#outflow-boundaries">Outflow Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/boundaries.html#inflow-boundaries">Inflow Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/boundaries.html#reflecting-boundaries">Reflecting Boundaries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/boundaries.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/boundaries.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api/mpi_manager.html">API Reference: MPI Manager</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#quick-reference">Quick Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#key-features">Key Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#data-members">Data Members</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#key-methods">Key Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/mpi_manager.html#domain-decomposition">Domain Decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/mpi_manager.html#communication">Communication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/mpi_manager.html#see-also">See Also</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional Resources</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Performance Tuning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#performance-overview">Performance Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#target-performance-metrics">Target Performance Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#typical-performance">Typical Performance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-tuning">Configuration Tuning</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#timestep-selection">Timestep Selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#particles-per-cell">Particles Per Cell</a></li>
<li class="toctree-l3"><a class="reference internal" href="#grid-resolution">Grid Resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#output-cadence">Output Cadence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cuda-optimization">CUDA Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#threads-per-block">Threads Per Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="#memory-pool-size">Memory Pool Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpu-selection">GPU Selection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mpi-optimization">MPI Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#domain-decomposition">Domain Decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cuda-aware-mpi">CUDA-Aware MPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overlap-communication">Overlap Communication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#profiling-and-analysis">Profiling and Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-nvidia-smi">Using nvidia-smi</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-nvprof">Using nvprof</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-nsight-systems">Using Nsight Systems</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#memory-usage-optimization">Memory Usage Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#estimate-memory-requirements">Estimate Memory Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reduce-memory-usage">Reduce Memory Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#common-performance-issues">Common Performance Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#slow-particle-push">Slow Particle Push</a></li>
<li class="toctree-l3"><a class="reference internal" href="#slow-particle-to-grid">Slow Particle-to-Grid</a></li>
<li class="toctree-l3"><a class="reference internal" href="#poor-mpi-scaling">Poor MPI Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#high-memory-usage">High Memory Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#best-practices-summary">Best Practices Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="#performance-checklist">Performance Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#build-issues">Build Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#nvcc-not-found">“nvcc not found”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#compute-capability-mismatch">“compute capability mismatch”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#mpi-not-found">“MPI not found”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#hdf5-not-found">“HDF5 not found”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#runtime-issues">Runtime Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#cuda-out-of-memory">“CUDA out of memory”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#no-cuda-capable-device">“No CUDA-capable device”</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#mpi-init-failed">“MPI_Init failed”</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#physics-issues">Physics Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#energy-not-conserved">Energy Not Conserved</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#no-magnetic-reconnection">No Magnetic Reconnection</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#particles-escaping-domain">Particles Escaping Domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#nan-values-appearing">NaN Values Appearing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#performance-issues">Performance Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#simulation-too-slow">Simulation Too Slow</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#poor-mpi-scaling">Poor MPI Scaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#gpu-thermal-throttling">GPU Thermal Throttling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#output-issues">Output Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#permission-denied-writing-output">“Permission denied” Writing Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#output-files-corrupted">Output Files Corrupted</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#diagnostic-collection">Diagnostic Collection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#before-reporting-issues">Before Reporting Issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#getting-help">Getting Help</a><ul>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#self-help-resources">Self-Help Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#reporting-bugs">Reporting Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="troubleshooting.html#community-support">Community Support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#quick-checks">Quick Checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#common-mistakes">Common Mistakes</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="citation.html">Citation and Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="citation.html#how-to-cite">How to Cite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="citation.html#bibtex-entry">BibTeX Entry</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#published-papers">Published Papers</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#acknowledgments">Acknowledgments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#contributing">Contributing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="citation.html#types-of-contributions">Types of Contributions</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#getting-started">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#code-style">Code Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#documentation">Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#testing">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#pull-request-guidelines">Pull Request Guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#reporting-bugs">Reporting Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#requesting-features">Requesting Features</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#code-of-conduct">Code of Conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#license">License</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#credits">Credits</a><ul>
<li class="toctree-l3"><a class="reference internal" href="citation.html#core-developers">Core Developers</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#id1">Acknowledgments</a></li>
<li class="toctree-l3"><a class="reference internal" href="citation.html#third-party-libraries">Third-Party Libraries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#contact">Contact</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#funding">Funding</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#publications-using-jericho-mk-ii">Publications Using Jericho Mk II</a></li>
<li class="toctree-l2"><a class="reference internal" href="citation.html#see-also">See Also</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Jericho Mk II</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Performance Tuning</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/performance_tuning.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="performance-tuning">
<h1>Performance Tuning<a class="headerlink" href="#performance-tuning" title="Link to this heading"></a></h1>
<p>This guide provides practical tips and strategies for optimizing Jericho Mk II performance on GPU and multi-GPU systems.</p>
<section id="performance-overview">
<h2>Performance Overview<a class="headerlink" href="#performance-overview" title="Link to this heading"></a></h2>
<section id="target-performance-metrics">
<h3>Target Performance Metrics<a class="headerlink" href="#target-performance-metrics" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 30.0%" />
<col style="width: 30.0%" />
<col style="width: 40.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Metric</p></th>
<th class="head"><p>Target</p></th>
<th class="head"><p>How to Measure</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Particle throughput</p></td>
<td><p>&gt; 1 Gparticles/s per GPU</p></td>
<td><p>Runtime output</p></td>
</tr>
<tr class="row-odd"><td><p>GPU utilization</p></td>
<td><p>&gt; 80%</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nvidia-smi</span> <span class="pre">dmon</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Memory bandwidth</p></td>
<td><p>&gt; 70% of peak</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nvprof</span> <span class="pre">--metrics</span> <span class="pre">dram_utilization</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Energy conservation</p></td>
<td><p><span class="math notranslate nohighlight">\(|\Delta E|/E &lt; 1\%\)</span> per 1000 steps</p></td>
<td><p>Check <code class="docutils literal notranslate"><span class="pre">diagnostics.csv</span></code></p></td>
</tr>
<tr class="row-even"><td><p>MPI efficiency (weak scaling)</p></td>
<td><p>&gt; 80% at 64 ranks</p></td>
<td><p>Scaling studies</p></td>
</tr>
<tr class="row-odd"><td><p>Time per timestep</p></td>
<td><p>&lt; 100 ms for 1M particles</p></td>
<td><p>Profile output</p></td>
</tr>
</tbody>
</table>
</section>
<section id="typical-performance">
<h3>Typical Performance<a class="headerlink" href="#typical-performance" title="Link to this heading"></a></h3>
<p><strong>Single GPU (NVIDIA A100):</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Configuration</p></th>
<th class="head"><p>Particles</p></th>
<th class="head"><p>Grid</p></th>
<th class="head"><p>Time/step</p></th>
<th class="head"><p>Throughput</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Small</p></td>
<td><p>100K</p></td>
<td><p>128×128</p></td>
<td><p>5 ms</p></td>
<td><p>20 Gparticles/s</p></td>
</tr>
<tr class="row-odd"><td><p>Medium</p></td>
<td><p>1M</p></td>
<td><p>256×256</p></td>
<td><p>25 ms</p></td>
<td><p>40 Gparticles/s</p></td>
</tr>
<tr class="row-even"><td><p>Large</p></td>
<td><p>10M</p></td>
<td><p>512×512</p></td>
<td><p>180 ms</p></td>
<td><p>56 Gparticles/s</p></td>
</tr>
</tbody>
</table>
<p><strong>Multi-GPU scaling (4x A100):</strong></p>
<ul class="simple">
<li><p>4M particles, 512×512 grid: ~60 ms/step (4x speedup vs 1 GPU)</p></li>
<li><p>16M particles, 1024×1024 grid: ~200 ms/step (3.6x speedup)</p></li>
</ul>
</section>
</section>
<section id="configuration-tuning">
<h2>Configuration Tuning<a class="headerlink" href="#configuration-tuning" title="Link to this heading"></a></h2>
<section id="timestep-selection">
<h3>Timestep Selection<a class="headerlink" href="#timestep-selection" title="Link to this heading"></a></h3>
<p><strong>CFL condition:</strong></p>
<p>The timestep must satisfy:</p>
<div class="math notranslate nohighlight">
\[\Delta t &lt; \min\left(\frac{\Delta x}{v_{\max}}, \frac{1}{\omega_{pe}}, \frac{1}{\Omega_i}\right)\]</div>
<p><strong>In practice:</strong></p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[simulation]</span>
<span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="w">  </span><span class="c1"># Start here (0.01 ion gyroperiods)</span>
</pre></div>
</div>
<p><strong>If energy drifts:</strong></p>
<ul class="simple">
<li><p>Reduce dt by 2x, check if energy conservation improves</p></li>
<li><p>If yes → timestep was too large</p></li>
<li><p>If no → check physics settings (CAM, Hall term)</p></li>
</ul>
<p><strong>If simulation is too slow:</strong></p>
<ul class="simple">
<li><p>Increase dt carefully (max 2x at a time)</p></li>
<li><p>Monitor energy conservation</p></li>
<li><p>Never exceed dt = 0.1 (unstable for most cases)</p></li>
</ul>
</section>
<section id="particles-per-cell">
<h3>Particles Per Cell<a class="headerlink" href="#particles-per-cell" title="Link to this heading"></a></h3>
<p><strong>Trade-off:</strong></p>
<ul class="simple">
<li><p>More particles → better statistics, slower</p></li>
<li><p>Fewer particles → noisier, faster</p></li>
</ul>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[particles]</span>
<span class="n">particles_per_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w">  </span><span class="c1"># Baseline</span>

<span class="c1"># For faster runs (acceptable for scoping studies):</span>
<span class="n">particles_per_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span>

<span class="c1"># For high-quality results:</span>
<span class="n">particles_per_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span>
</pre></div>
</div>
<p><strong>Effect on performance:</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>PPC</p></th>
<th class="head"><p>Particle count</p></th>
<th class="head"><p>Time/step</p></th>
<th class="head"><p>Statistical noise</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>25</p></td>
<td><p>1.6M</p></td>
<td><p>10 ms</p></td>
<td><p>±5%</p></td>
</tr>
<tr class="row-odd"><td><p>50</p></td>
<td><p>3.3M</p></td>
<td><p>18 ms</p></td>
<td><p>±3%</p></td>
</tr>
<tr class="row-even"><td><p>100</p></td>
<td><p>6.6M</p></td>
<td><p>35 ms</p></td>
<td><p>±2%</p></td>
</tr>
<tr class="row-odd"><td><p>200</p></td>
<td><p>13.1M</p></td>
<td><p>68 ms</p></td>
<td><p>±1%</p></td>
</tr>
</tbody>
</table>
</section>
<section id="grid-resolution">
<h3>Grid Resolution<a class="headerlink" href="#grid-resolution" title="Link to this heading"></a></h3>
<p><strong>Physics constraint:</strong></p>
<p>Grid spacing should resolve Debye length:</p>
<div class="math notranslate nohighlight">
\[\Delta x \lesssim 0.5 \lambda_D = 0.5 \sqrt{\frac{\epsilon_0 k_B T_e}{n_e e^2}}\]</div>
<p><strong>Computational constraint:</strong></p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[domain]</span>
<span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="w">  </span><span class="c1"># Baseline</span>
<span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span>

<span class="c1"># For faster runs:</span>
<span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span>
<span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span>

<span class="c1"># For high resolution:</span>
<span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span>
<span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span>
</pre></div>
</div>
<p><strong>Effect:</strong></p>
<ul class="simple">
<li><p>2x grid resolution → 4x cells → ~4x slower (if particle-limited)</p></li>
<li><p>But: Doubling grid with same PPC → 4x more particles → ~8x slower</p></li>
</ul>
<p><strong>Recommendation:</strong> Start with 128×128, increase only if physics requires</p>
</section>
<section id="output-cadence">
<h3>Output Cadence<a class="headerlink" href="#output-cadence" title="Link to this heading"></a></h3>
<p><strong>Writing output is slow!</strong></p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[simulation]</span>
<span class="n">output_cadence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w">   </span><span class="c1"># Write every 100 steps</span>

<span class="c1"># For production (fewer files):</span>
<span class="n">output_cadence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span>

<span class="c1"># For debugging (more frequent):</span>
<span class="n">output_cadence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>
</pre></div>
</div>
<p><strong>Effect:</strong></p>
<ul class="simple">
<li><p>Writing fields: ~50-200 ms per output</p></li>
<li><p>Writing particles: ~100-500 ms per output</p></li>
<li><p>At output_cadence=10, I/O can dominate runtime!</p></li>
</ul>
<p><strong>Best practice:</strong></p>
<ul>
<li><p>Use large cadence for production (500-1000)</p></li>
<li><p>Use small cadence for debugging (10-50)</p></li>
<li><p>Disable particle output if not needed:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[output]</span>
<span class="n">particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w">  </span><span class="c1"># Saves a lot of time!</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="cuda-optimization">
<h2>CUDA Optimization<a class="headerlink" href="#cuda-optimization" title="Link to this heading"></a></h2>
<section id="threads-per-block">
<h3>Threads Per Block<a class="headerlink" href="#threads-per-block" title="Link to this heading"></a></h3>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[cuda]</span>
<span class="n">threads_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="w">  </span><span class="c1"># Baseline (good for most GPUs)</span>
</pre></div>
</div>
<p><strong>Try different values:</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Threads/block</p></th>
<th class="head"><p>Occupancy</p></th>
<th class="head"><p>Performance</p></th>
<th class="head"><p>Best for</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>128</p></td>
<td><p>50-75%</p></td>
<td><p>Moderate</p></td>
<td><p>Old GPUs (compute 6.0)</p></td>
</tr>
<tr class="row-odd"><td><p>256</p></td>
<td><p>75-100%</p></td>
<td><p>Good</p></td>
<td><p>Most GPUs (default)</p></td>
</tr>
<tr class="row-even"><td><p>512</p></td>
<td><p>75-100%</p></td>
<td><p>Best</p></td>
<td><p>Ampere/Hopper (compute 8.0+)</p></td>
</tr>
<tr class="row-odd"><td><p>1024</p></td>
<td><p>100%</p></td>
<td><p>Variable</p></td>
<td><p>Register-limited kernels</p></td>
</tr>
</tbody>
</table>
<p><strong>How to test:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Benchmark different settings</span>
<span class="k">for</span><span class="w"> </span>threads<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">128</span><span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="m">512</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Testing threads_per_block=</span><span class="nv">$threads</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="c1"># Edit config.toml: threads_per_block = $threads</span>
<span class="w">    </span><span class="nb">time</span><span class="w"> </span>./jericho_mkII<span class="w"> </span>config.toml
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="memory-pool-size">
<h3>Memory Pool Size<a class="headerlink" href="#memory-pool-size" title="Link to this heading"></a></h3>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[cuda]</span>
<span class="n">memory_pool_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1"># Auto (default)</span>

<span class="c1"># For large simulations, pre-allocate:</span>
<span class="n">memory_pool_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8192</span><span class="w">  </span><span class="c1"># 8 GB</span>
</pre></div>
</div>
<p><strong>Benefits:</strong></p>
<ul class="simple">
<li><p>Avoids runtime allocation overhead</p></li>
<li><p>Reduces memory fragmentation</p></li>
<li><p>Faster particle insertion/removal</p></li>
</ul>
<p><strong>Drawback:</strong></p>
<ul class="simple">
<li><p>Uses memory even if not needed</p></li>
<li><p>May run out if too small</p></li>
</ul>
<p><strong>Recommendation:</strong> Use 0 (auto) unless you see many allocations in profile</p>
</section>
<section id="gpu-selection">
<h3>GPU Selection<a class="headerlink" href="#gpu-selection" title="Link to this heading"></a></h3>
<p><strong>For multi-GPU systems:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let code auto-assign</span>
./jericho_mkII<span class="w"> </span>config.toml

<span class="c1"># Or manually specify</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>./jericho_mkII<span class="w"> </span>config.toml

<span class="c1"># Check which GPU is faster</span>
nvidia-smi<span class="w"> </span>--query-gpu<span class="o">=</span>name,memory.total,clocks.max.sm<span class="w"> </span>--format<span class="o">=</span>csv
</pre></div>
</div>
<p><strong>Prefer:</strong></p>
<ul class="simple">
<li><p>Newer architecture (Ampere &gt; Turing &gt; Volta)</p></li>
<li><p>Higher memory bandwidth</p></li>
<li><p>More SMs (streaming multiprocessors)</p></li>
</ul>
</section>
</section>
<section id="mpi-optimization">
<h2>MPI Optimization<a class="headerlink" href="#mpi-optimization" title="Link to this heading"></a></h2>
<section id="domain-decomposition">
<h3>Domain Decomposition<a class="headerlink" href="#domain-decomposition" title="Link to this heading"></a></h3>
<p><strong>Rule 1: Match aspect ratios</strong></p>
<p>If domain is 1024×512 (2:1 aspect ratio):</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[mpi]</span>
<span class="c1"># Good: 2:1 decomposition</span>
<span class="n">npx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="n">npy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>

<span class="c1"># Bad: 1:2 decomposition (mismatched)</span>
<span class="n">npx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="n">npy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
</pre></div>
</div>
<p><strong>Rule 2: Keep subdomains large enough</strong></p>
<p>Each subdomain should have ≥ 64×64 interior cells:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[domain]</span>
<span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span>
<span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span>

<span class="k">[mpi]</span>
<span class="c1"># Good: 128×128 per rank</span>
<span class="n">npx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="n">npy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>

<span class="c1"># Bad: 64×64 per rank (too small, communication-heavy)</span>
<span class="n">npx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>
<span class="n">npy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>
</pre></div>
</div>
<p><strong>Rule 3: Power-of-2 decompositions</strong></p>
<p>Use npx, npy as powers of 2 (1, 2, 4, 8, 16) for best MPI performance.</p>
</section>
<section id="cuda-aware-mpi">
<h3>CUDA-Aware MPI<a class="headerlink" href="#cuda-aware-mpi" title="Link to this heading"></a></h3>
<p><strong>Enable if available:</strong></p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[cuda]</span>
<span class="n">use_cuda_aware_mpi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</pre></div>
</div>
<p><strong>Verify:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check if MPI supports CUDA</span>
ompi_info<span class="w"> </span>--parsable<span class="w"> </span>--all<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>mpi_built_with_cuda_support:value
</pre></div>
</div>
<p><strong>Performance gain:</strong> 2-5x faster communication</p>
<p><strong>If not available:</strong></p>
<ul class="simple">
<li><p>Upgrade MPI (OpenMPI 4.0+, MPICH 3.3+)</p></li>
<li><p>Or build from source with <code class="docutils literal notranslate"><span class="pre">--with-cuda</span></code> flag</p></li>
</ul>
</section>
<section id="overlap-communication">
<h3>Overlap Communication<a class="headerlink" href="#overlap-communication" title="Link to this heading"></a></h3>
<p><strong>Already implemented in code</strong>, but you can tune:</p>
<ul class="simple">
<li><p>Increase local work to better hide communication</p></li>
<li><p>Use larger subdomains (less boundary/interior ratio)</p></li>
</ul>
</section>
</section>
<section id="profiling-and-analysis">
<h2>Profiling and Analysis<a class="headerlink" href="#profiling-and-analysis" title="Link to this heading"></a></h2>
<section id="using-nvidia-smi">
<h3>Using nvidia-smi<a class="headerlink" href="#using-nvidia-smi" title="Link to this heading"></a></h3>
<p><strong>Monitor in real-time:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Terminal 1: Run simulation</span>
./jericho_mkII<span class="w"> </span>config.toml

<span class="c1"># Terminal 2: Monitor GPU</span>
watch<span class="w"> </span>-n<span class="w"> </span><span class="m">0</span>.5<span class="w"> </span>nvidia-smi
</pre></div>
</div>
<p><strong>Look for:</strong></p>
<ul class="simple">
<li><p>GPU utilization: Should be &gt; 80%</p></li>
<li><p>Memory usage: Should not exceed GPU memory (causes swapping)</p></li>
<li><p>Temperature: &lt; 85°C (throttles if higher)</p></li>
<li><p>Power usage: Near TDP means GPU is working hard</p></li>
</ul>
</section>
<section id="using-nvprof">
<h3>Using nvprof<a class="headerlink" href="#using-nvprof" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Profile kernel execution</span>
nvprof<span class="w"> </span>./jericho_mkII<span class="w"> </span>config.toml<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>profile.txt
</pre></div>
</div>
<p><strong>Key metrics:</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Time(%)  Time      Calls  Avg        Min        Max   Name
45.2%    2.105s    1000   2.105ms    2.098ms    2.112ms  advance_particles_kernel
28.3%    1.317s    1000   1.317ms    1.310ms    1.324ms  deposit_charge_current_kernel
15.1%    702.3ms   1000   702.3us    695.2us    710.1us  compute_electric_field_kernel
8.7%     405.2ms   1000   405.2us    400.1us    410.5us  update_magnetic_field_kernel
</pre></div>
</div>
<p><strong>Analysis:</strong></p>
<ul class="simple">
<li><p>Particle push: 45% of time (expected, particle-heavy)</p></li>
<li><p>Deposit: 28% (atomic operations, expected)</p></li>
<li><p>Field updates: 24% (grid operations)</p></li>
</ul>
<p><strong>If particle push is slow:</strong></p>
<ul class="simple">
<li><p>Check memory bandwidth: <code class="docutils literal notranslate"><span class="pre">nvprof</span> <span class="pre">--metrics</span> <span class="pre">dram_utilization</span></code></p></li>
<li><p>Should be &gt; 70% (memory-bound is expected)</p></li>
</ul>
<p><strong>If deposit is slow:</strong></p>
<ul class="simple">
<li><p>Atomic contention (expected with many particles/cell)</p></li>
<li><p>Try reducing particles_per_cell</p></li>
</ul>
</section>
<section id="using-nsight-systems">
<h3>Using Nsight Systems<a class="headerlink" href="#using-nsight-systems" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Detailed timeline</span>
nsys<span class="w"> </span>profile<span class="w"> </span>-o<span class="w"> </span>jericho_profile<span class="w"> </span>./jericho_mkII<span class="w"> </span>config.toml

<span class="c1"># Open GUI</span>
nsys-ui<span class="w"> </span>jericho_profile.qdrep
</pre></div>
</div>
<p><strong>Look for:</strong></p>
<ul class="simple">
<li><p>GPU idle time (gaps between kernels)</p></li>
<li><p>CPU-GPU synchronization overhead</p></li>
<li><p>MPI communication time</p></li>
<li><p>I/O bottlenecks</p></li>
</ul>
<p><strong>Optimize:</strong></p>
<ul class="simple">
<li><p>Reduce CPU-GPU sync (use async operations)</p></li>
<li><p>Overlap computation and communication</p></li>
<li><p>Reduce I/O frequency</p></li>
</ul>
</section>
</section>
<section id="memory-usage-optimization">
<h2>Memory Usage Optimization<a class="headerlink" href="#memory-usage-optimization" title="Link to this heading"></a></h2>
<section id="estimate-memory-requirements">
<h3>Estimate Memory Requirements<a class="headerlink" href="#estimate-memory-requirements" title="Link to this heading"></a></h3>
<p><strong>Particle memory:</strong></p>
<div class="math notranslate nohighlight">
\[M_{\text{particles}} = 48 \times N_{\text{cells}} \times N_{\text{ppc}} \times N_{\text{species}} \text{ bytes}\]</div>
<p><strong>Field memory:</strong></p>
<div class="math notranslate nohighlight">
\[M_{\text{fields}} = 8 \times N_{\text{fields}} \times N_{\text{cells}} \text{ bytes}\]</div>
<p><strong>Example:</strong></p>
<ul class="simple">
<li><p>256×256 grid, 100 ppc, 2 species: 314 MB particles</p></li>
<li><p>256×256 grid, 10 fields: 52 MB fields</p></li>
<li><p>Total: ~400 MB (fits easily on any GPU)</p></li>
</ul>
<p><strong>For 1024×1024 grid, 200 ppc:</strong></p>
<ul class="simple">
<li><p>Particles: 5 GB</p></li>
<li><p>Fields: 0.8 GB</p></li>
<li><p>Total: ~6 GB (needs ≥ 8 GB GPU)</p></li>
</ul>
</section>
<section id="reduce-memory-usage">
<h3>Reduce Memory Usage<a class="headerlink" href="#reduce-memory-usage" title="Link to this heading"></a></h3>
<p><strong>Option 1: Reduce particles per cell</strong></p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[particles]</span>
<span class="n">particles_per_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="w">  </span><span class="c1"># Instead of 100</span>
</pre></div>
</div>
<p>Saves 50% particle memory, but noisier statistics.</p>
<p><strong>Option 2: Reduce grid resolution</strong></p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[domain]</span>
<span class="n">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="w">  </span><span class="c1"># Instead of 1024</span>
<span class="n">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span>
</pre></div>
</div>
<p>Saves 75% memory, but lower spatial resolution.</p>
<p><strong>Option 3: Use single precision (experimental)</strong></p>
<p>Not currently implemented, but could save 50% memory.</p>
<p><strong>Option 4: Remove unused species</strong></p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[particles]</span>
<span class="c1"># Remove O+ if not needed</span>
<span class="k">[[particles.species]]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;H+&quot;</span>
<span class="c1"># ...</span>
</pre></div>
</div>
</section>
</section>
<section id="common-performance-issues">
<h2>Common Performance Issues<a class="headerlink" href="#common-performance-issues" title="Link to this heading"></a></h2>
<section id="slow-particle-push">
<h3>Slow Particle Push<a class="headerlink" href="#slow-particle-push" title="Link to this heading"></a></h3>
<p><strong>Symptoms:</strong></p>
<ul class="simple">
<li><p>Low GPU utilization (&lt; 50%)</p></li>
<li><p>Low memory bandwidth (&lt; 50%)</p></li>
</ul>
<p><strong>Causes:</strong></p>
<ol class="arabic">
<li><p><strong>Too few particles</strong>: GPU underutilized</p>
<p><strong>Fix:</strong> Increase particles_per_cell or grid resolution</p>
</li>
<li><p><strong>Divergent branches</strong>: if/else in kernel</p>
<p><strong>Fix:</strong> Minimize conditionals (already optimized in code)</p>
</li>
<li><p><strong>Uncoalesced memory access</strong>: Wrong data layout</p>
<p><strong>Fix:</strong> Use SoA (already implemented)</p>
</li>
</ol>
</section>
<section id="slow-particle-to-grid">
<h3>Slow Particle-to-Grid<a class="headerlink" href="#slow-particle-to-grid" title="Link to this heading"></a></h3>
<p><strong>Symptoms:</strong></p>
<ul class="simple">
<li><p>Long time in deposit_charge_current_kernel</p></li>
<li><p>Many atomic operations</p></li>
</ul>
<p><strong>Causes:</strong></p>
<ol class="arabic">
<li><p><strong>Atomic contention</strong>: Many particles in same cell</p>
<p><strong>Fix:</strong>
- Reduce particles_per_cell
- Use shared memory optimization (already implemented)</p>
</li>
<li><p><strong>Irregular particle distribution</strong>: Load imbalance</p>
<p><strong>Fix:</strong> Use MPI domain decomposition</p>
</li>
</ol>
</section>
<section id="poor-mpi-scaling">
<h3>Poor MPI Scaling<a class="headerlink" href="#poor-mpi-scaling" title="Link to this heading"></a></h3>
<p><strong>Symptoms:</strong></p>
<ul class="simple">
<li><p>4 GPUs not 4x faster than 1 GPU</p></li>
<li><p>High MPI communication time</p></li>
</ul>
<p><strong>Causes:</strong></p>
<ol class="arabic">
<li><p><strong>Subdomains too small</strong>: High communication/computation ratio</p>
<p><strong>Fix:</strong> Use larger subdomains (≥ 128×128 per rank)</p>
</li>
<li><p><strong>No CUDA-aware MPI</strong>: Slow CPU staging</p>
<p><strong>Fix:</strong> Enable CUDA-aware MPI</p>
</li>
<li><p><strong>Load imbalance</strong>: Some ranks finish before others</p>
<p><strong>Fix:</strong> Check particle distribution, use load balancing (experimental)</p>
</li>
</ol>
</section>
<section id="high-memory-usage">
<h3>High Memory Usage<a class="headerlink" href="#high-memory-usage" title="Link to this heading"></a></h3>
<p><strong>Symptoms:</strong></p>
<ul class="simple">
<li><p>Out of memory error</p></li>
<li><p>GPU memory usage &gt; available</p></li>
</ul>
<p><strong>Causes:</strong></p>
<ol class="arabic">
<li><p><strong>Too many particles</strong></p>
<p><strong>Fix:</strong> Reduce particles_per_cell or grid size</p>
</li>
<li><p><strong>Memory leak</strong> (bug)</p>
<p><strong>Fix:</strong> Report issue on GitHub</p>
</li>
<li><p><strong>Multiple simulations on same GPU</strong></p>
<p><strong>Fix:</strong> Use CUDA_VISIBLE_DEVICES to assign different GPUs</p>
</li>
</ol>
</section>
</section>
<section id="best-practices-summary">
<h2>Best Practices Summary<a class="headerlink" href="#best-practices-summary" title="Link to this heading"></a></h2>
<p><strong>For production runs:</strong></p>
<ol class="arabic simple">
<li><p>Start with baseline config (256×256, 100 ppc, dt=0.01)</p></li>
<li><p>Run short test (100 steps) and check energy conservation</p></li>
<li><p>Profile to identify bottlenecks</p></li>
<li><p>Tune one parameter at a time</p></li>
<li><p>Document changes and performance impact</p></li>
<li><p>Use large output_cadence (500-1000)</p></li>
<li><p>Enable checkpointing (checkpoint_cadence=500)</p></li>
</ol>
<p><strong>For development/debugging:</strong></p>
<ol class="arabic simple">
<li><p>Use small config (128×128, 25 ppc)</p></li>
<li><p>Small output_cadence (10-50)</p></li>
<li><p>Enable verbose output</p></li>
<li><p>Run short tests (10-100 steps)</p></li>
</ol>
<p><strong>For scaling studies:</strong></p>
<ol class="arabic simple">
<li><p>Fix work per rank (weak scaling) or total work (strong scaling)</p></li>
<li><p>Measure time to solution</p></li>
<li><p>Plot scaling efficiency</p></li>
<li><p>Identify scaling bottlenecks (communication, load imbalance)</p></li>
</ol>
</section>
<section id="performance-checklist">
<h2>Performance Checklist<a class="headerlink" href="#performance-checklist" title="Link to this heading"></a></h2>
<p>Before running production simulations, verify:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>☐ Energy conservation &lt; 1% per 1000 steps
☐ GPU utilization &gt; 80% (check nvidia-smi)
☐ Memory usage &lt; 90% of GPU memory
☐ Timestep satisfies CFL condition
☐ Adequate particles per cell (≥ 50 for statistics)
☐ Grid resolution adequate (≥ 2 cells per Debye length)
☐ Output cadence reasonable (not writing every step)
☐ CUDA-aware MPI enabled (if using multi-GPU)
☐ Subdomain sizes adequate (≥ 64×64 per rank)
☐ Profile shows no obvious bottlenecks
</pre></div>
</div>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="architecture.html"><span class="doc">Architecture and Design</span></a> - System design</p></li>
<li><p><a class="reference internal" href="cuda_kernels.html"><span class="doc">CUDA Kernels</span></a> - GPU implementation details</p></li>
<li><p><a class="reference internal" href="mpi_parallelism.html"><span class="doc">MPI Parallelism</span></a> - Multi-GPU scaling</p></li>
<li><p><a class="reference internal" href="troubleshooting.html"><span class="doc">Troubleshooting</span></a> - Common issues</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="api/mpi_manager.html" class="btn btn-neutral float-left" title="API Reference: MPI Manager" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="troubleshooting.html" class="btn btn-neutral float-right" title="Troubleshooting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lancaster University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>